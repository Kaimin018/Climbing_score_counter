{% extends 'base.html' %}
{% load static %}

{% block title %}æ’è¡Œæ¦œ - æ”€å²©è¨ˆåˆ†ç³»çµ±{% endblock %}

{% block content %}
<div class="leaderboard-layout">
    <!-- ç§»å‹•ç«¯æˆ¿é–“æ¨™é¡Œï¼ˆé¡¯ç¤ºåœ¨æ’è¡Œæ¦œä¸Šæ–¹ï¼‰ -->
    <div class="room-header-mobile" id="roomHeaderMobile">
        <div class="room-info">
            <span>æˆ¿é–“ ID: <strong id="roomIdDisplayMobile">-</strong></span>
            <span style="margin-left: 20px;">æ¯ä¸€æ¢ç·šç¸½åˆ† (L): <strong id="standardLineScoreMobile">-</strong></span>
        </div>
        <div class="header-top">
            <div class="header-buttons">
                <button class="btn btn-secondary btn-square" onclick="goHome()" title="è¿”å›é¦–é " style="font-size: 1.3rem; line-height: 1;">
                    â†
                </button>
                <button class="btn btn-primary btn-square" onclick="showAddRouteModal()" title="æ–°å¢è·¯ç·š" style="font-size: 1.1rem; line-height: 1;">
                    ğŸ§—
                </button>
                <button class="btn btn-secondary btn-square" onclick="showEditRoomModal()" title="ç·¨è¼¯æˆ¿é–“" style="font-size: 1.3rem; line-height: 1;">
                    âœï¸
                </button>
            </div>
        </div>
    </div>

    <!-- å·¦å´ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <div class="leaderboard-container">
            <div class="room-header" id="roomHeader">
                <div class="header-top">
                    <button class="btn btn-secondary btn-small" onclick="goHome()" style="margin-right: 10px;">
                        â† è¿”å›é¦–é 
                    </button>
                    <h2 id="roomName" style="flex: 1;">è¼‰å…¥ä¸­...</h2>
                    <a href="/rules/" class="btn btn-secondary btn-small" style="margin-left: 10px; text-decoration: none; display: inline-block;">
                        è¦å‰‡èªªæ˜
                    </a>
                    <button class="btn btn-secondary btn-small" onclick="showEditRoomModal()" style="margin-left: 10px;">
                        ç·¨è¼¯æˆ¿é–“
                    </button>
                </div>
                <div class="room-info">
                    <span>æˆ¿é–“ ID: <strong id="roomIdDisplay">-</strong></span>
                    <span style="margin-left: 20px;">æ¯ä¸€æ¢ç·šç¸½åˆ† (L): <strong id="standardLineScore">-</strong></span>
                </div>
            </div>


            <div class="routes-section">
                <h3>è·¯ç·šåˆ—è¡¨</h3>
                <div id="routesList" class="routes-list">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´å›ºå®šæ’è¡Œæ¦œ -->
    <div class="leaderboard-sidebar">
        <div class="leaderboard-sidebar-header">
            <h3>æ’è¡Œæ¦œ<span class="room-title-inline" id="roomTitleInline"></span></h3>
            <button class="btn btn-secondary btn-small" onclick="refreshLeaderboard()" title="åˆ·æ–°æ’è¡Œæ¦œ">
                ğŸ”„
            </button>
        </div>
        <div class="leaderboard-table-wrapper">
            <div class="leaderboard-table">
                <table>
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æˆå“¡</th>
                            <th>ç¸½åˆ†</th>
                            <th>å®Œæˆæ¢æ•¸</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr>
                            <td colspan="5" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢æˆå“¡å½ˆçª— -->
<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å¢æˆå“¡</h3>
            <span class="close" onclick="closeAddMemberModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addMemberForm">
                <div class="form-group">
                    <label for="memberName">æˆå“¡åç¨±:</label>
                    <input type="text" id="memberName" name="name" required placeholder="è«‹è¼¸å…¥æˆå“¡åç¨±">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isCustomCalc" name="is_custom_calc">
                        æ˜¯å¦ç‚ºå®¢è£½åŒ–çµ„
                    </label>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        å‹¾é¸å¾Œï¼Œè©²æˆå“¡æ¯å®Œæˆä¸€æ¢è·¯ç·šå›ºå®šç²å¾— L åˆ†ï¼Œä¸æœƒè¢«å…¶ä»–æˆå“¡åˆ†æ”¤åˆ†æ•¸ã€‚é©åˆç¨‹åº¦è¼ƒä½çš„æœ‹å‹åŠ å…¥å°æˆ°ã€‚
                    </small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºæˆå“¡</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMemberModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æˆå“¡å½ˆçª— -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯æˆå“¡</h3>
            <span class="close" onclick="closeEditMemberModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId" name="member_id">
                <div class="form-group">
                    <label for="editMemberName">æˆå“¡åç¨±:</label>
                    <input type="text" id="editMemberName" name="name" required placeholder="è«‹è¼¸å…¥æˆå“¡åç¨±">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsCustomCalc" name="is_custom_calc">
                        æ˜¯å¦ç‚ºå®¢è£½åŒ–çµ„
                    </label>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        å‹¾é¸å¾Œï¼Œè©²æˆå“¡æ¯å®Œæˆä¸€æ¢è·¯ç·šå›ºå®šç²å¾— L åˆ†ï¼Œä¸æœƒè¢«å…¶ä»–æˆå“¡åˆ†æ”¤åˆ†æ•¸ã€‚é©åˆç¨‹åº¦è¼ƒä½çš„æœ‹å‹åŠ å…¥å°æˆ°ã€‚
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteMemberFromEditModal()" style="margin-right: auto;">
                        åˆªé™¤æˆå“¡
                    </button>
                    <button type="submit" class="btn btn-primary">æ›´æ–°æˆå“¡</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditMemberModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æˆ¿é–“å½ˆçª— -->
<div id="editRoomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯æˆ¿é–“</h3>
            <span class="close" onclick="closeEditRoomModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editRoomForm">
                <input type="hidden" id="editRoomId" name="room_id">
                <div class="form-group">
                    <label for="editRoomName">æˆ¿é–“åç¨±:</label>
                    <input type="text" id="editRoomName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editRoomStandardLineScore">æ¯ä¸€æ¢ç·šç¸½åˆ† (L):</label>
                    <input type="number" id="editRoomStandardLineScore" name="standard_line_score" 
                           min="1" max="100" required disabled>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        æ¯ä¸€æ¢ç·šç¸½åˆ†æœƒè‡ªå‹•æ ¹æ“šä¸€èˆ¬çµ„æˆå“¡æ•¸è¨ˆç®—ï¼ˆæœ€å°å…¬å€æ•¸ï¼‰ï¼Œç„¡æ³•æ‰‹å‹•ä¿®æ”¹
                    </small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æ›´æ–°æˆ¿é–“</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRoomModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯è·¯ç·šå½ˆçª— -->
<div id="editRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯è·¯ç·š</h3>
            <span class="close" onclick="closeEditRouteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editRouteForm">
                <input type="hidden" id="editRouteId" name="route_id">
                <div class="form-group">
                    <label for="editRouteName">è·¯ç·šåç¨±:</label>
                    <input type="text" id="editRouteName" name="name" required placeholder="ä¾‹å¦‚ï¼š123456">
                    <small style="display: block; color: #666; margin-top: 5px;">
                        è¼¸å…¥çš„åç¨±æœƒè‡ªå‹•åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´ï¼ˆç·¨è¼¯æ™‚æœƒè‡ªå‹•ç§»é™¤å‰ç¶´ä»¥ä¾¿ä¿®æ”¹ï¼‰
                    </small>
                </div>
                <div class="form-group">
                    <label for="editRouteGrade">é›£åº¦ç­‰ç´š (Grade):</label>
                    <select id="editRouteGrade" name="grade">
                        <option value="">è«‹é¸æ“‡é›£åº¦</option>
                        <option value="V1">V1</option>
                        <option value="V2">V2</option>
                        <option value="V3">V3</option>
                        <option value="V4">V4</option>
                        <option value="V5">V5</option>
                        <option value="V6">V6</option>
                        <option value="V7">V7</option>
                        <option value="V8+">V8+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editRoutePhoto">ç…§ç‰‡:</label>
                    <!-- éš±è—çš„æ–‡ä»¶è¼¸å…¥æ¡† -->
                    <input type="file" id="editRoutePhoto" name="photo" accept="image/*" style="display: none;">
                    <input type="file" id="editRoutePhotoFromGallery" name="photo" accept="image/*" style="display: none;">
                    
                    <!-- ç…§ç‰‡é¸æ“‡æŒ‰éˆ• -->
                    <div class="photo-upload-buttons" style="margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="triggerEditGallerySelect()" style="width: 100%;">
                            ğŸ–¼ï¸ é¸æ“‡ç…§ç‰‡ï¼ˆå¯æ‹ç…§æˆ–å¾åœ–åº«é¸æ“‡ï¼‰
                        </button>
                    </div>
                    
                    <!-- ç…§ç‰‡é è¦½ -->
                    <div id="editRoutePhotoPreview" style="margin-top: 10px;"></div>
                    
                    <small style="display: block; color: #666; margin-top: 5px;">
                        é»æ“ŠæŒ‰éˆ•å¯é¸æ“‡ç…§ç‰‡ï¼ˆæ”¯æŒæ‹ç…§æˆ–å¾åœ–åº«é¸æ“‡ï¼‰ã€‚å¦‚éœ€æ›´æ›ç…§ç‰‡ï¼Œè«‹é¸æ“‡æ–°ç…§ç‰‡ã€‚
                    </small>
                </div>
                <div class="form-group">
                    <label>æˆå“¡å®Œæˆç‹€æ…‹:</label>
                    <div id="editMemberCompletions" class="member-completions">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteRouteFromEditModal()" style="margin-right: auto;">
                        åˆªé™¤è·¯ç·š
                    </button>
                    <button type="submit" class="btn btn-primary">æ›´æ–°è·¯ç·š</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRouteModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹å®Œæˆè·¯ç·šå½ˆçª— -->
<div id="completedRoutesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="completedRoutesModalTitle">å®Œæˆçš„è·¯ç·š</h3>
            <span class="close" onclick="closeCompletedRoutesModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="completedRoutesList" class="completed-routes-list">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- åœ–ç‰‡å¤§åœ–æŸ¥çœ‹å½ˆçª— -->
<div id="photoModal" class="modal">
    <div class="modal-content photo-modal-content">
        <div class="modal-header">
            <h3 id="photoModalTitle">è·¯ç·šåœ–ç‰‡</h3>
            <span class="close" onclick="closePhotoModal()">&times;</span>
        </div>
        <div class="modal-body photo-modal-body">
            <img id="photoModalImage" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;">
        </div>
    </div>
</div>

<!-- æ–°å¢è·¯ç·šå½ˆçª— -->
<div id="addRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å¢è·¯ç·š</h3>
            <span class="close" onclick="closeAddRouteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addRouteForm">
                <div class="form-group">
                    <label for="routeName">è·¯ç·šåç¨±:</label>
                    <input type="text" id="routeName" name="name" required placeholder="è·¯ç·š1">
                    <small style="display: block; color: #666; margin-top: 5px;">
                        è¼¸å…¥çš„åç¨±æœƒè‡ªå‹•åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´
                    </small>
                </div>
                <div class="form-group">
                    <label for="routeGrade">é›£åº¦ç­‰ç´š (Grade): <span style="color: red;">*</span></label>
                    <select id="routeGrade" name="grade" required>
                        <option value="">è«‹é¸æ“‡é›£åº¦</option>
                        <option value="V1">V1</option>
                        <option value="V2">V2</option>
                        <option value="V3">V3</option>
                        <option value="V4">V4</option>
                        <option value="V5">V5</option>
                        <option value="V6">V6</option>
                        <option value="V7">V7</option>
                        <option value="V8+">V8+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="routePhoto">ç…§ç‰‡:</label>
                    <!-- éš±è—çš„æ–‡ä»¶è¼¸å…¥æ¡† -->
                    <input type="file" id="routePhoto" name="photo" accept="image/*" style="display: none;">
                    <input type="file" id="routePhotoFromGallery" name="photo" accept="image/*" style="display: none;">
                    
                    <!-- ç…§ç‰‡é¸æ“‡æŒ‰éˆ• -->
                    <div class="photo-upload-buttons" style="margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="triggerGallerySelect()" style="width: 100%;">
                            ğŸ–¼ï¸ é¸æ“‡ç…§ç‰‡ï¼ˆå¯æ‹ç…§æˆ–å¾åœ–åº«é¸æ“‡ï¼‰
                        </button>
                    </div>
                    
                    <!-- ç…§ç‰‡é è¦½ -->
                    <div id="routePhotoPreview" style="margin-top: 10px; display: none;">
                        <img id="routePhotoPreviewImg" src="" alt="ç…§ç‰‡é è¦½" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">
                        <button type="button" class="btn btn-small btn-danger" onclick="clearRoutePhoto()" style="margin-left: 10px; margin-top: 5px;">
                            æ¸…é™¤ç…§ç‰‡
                        </button>
                    </div>
                    
                    <small style="display: block; color: #666; margin-top: 5px;">
                        é»æ“ŠæŒ‰éˆ•å¯é¸æ“‡ç…§ç‰‡ï¼ˆæ”¯æŒæ‹ç…§æˆ–å¾åœ–åº«é¸æ“‡ï¼‰
                    </small>
                </div>
                <div class="form-group">
                    <label>æˆå“¡å®Œæˆç‹€æ…‹:</label>
                    <div id="memberCompletions" class="member-completions">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºè·¯ç·š</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddRouteModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .dropdown-content a {
        color: #333;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        cursor: pointer;
    }
    
    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }
    
    .dropdown-content a:first-child {
        border-bottom: 1px solid #ddd;
    }
</style>
<script>
    // ç²å– CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    let ROOM_ID = {{ room_id|default:1 }};
    
    function goHome() {
        window.location.href = '/';
    }
    
    function toggleDropdown(event, dropdownId) {
        event.stopPropagation();
        // é—œé–‰æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå–®
        document.querySelectorAll('.dropdown-content').forEach(function(dropdown) {
            if (dropdown.id !== dropdownId) {
                dropdown.style.display = 'none';
            }
        });
        // åˆ‡æ›ç•¶å‰ä¸‹æ‹‰èœå–®
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    function closeDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
    
    // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚é—œé–‰æ‰€æœ‰ä¸‹æ‹‰èœå–®
    // Toast é€šçŸ¥å‡½æ•°ï¼ˆæ›¿ä»£ alertï¼‰
    function showToast(message, type = 'info', duration = 3000) {
        // ç§»é™¤ç°æœ‰çš„ toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    // æŒ‰é’®åŠ è½½çŠ¶æ€ç®¡ç†
    function setButtonLoading(button, isLoading) {
        if (!button) return;
        
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.textContent;
            button.classList.add('loading');
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
        } else {
            button.disabled = false;
            button.classList.remove('loading');
            button.textContent = button.dataset.originalText || button.textContent;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
        }
    }

    // ä¹è§‚æ›´æ–°ï¼šæ·»åŠ æˆå‘˜åˆ°æ’è¡Œæ¦œï¼ˆä¸´æ—¶æ˜¾ç¤ºï¼‰
    function addMemberToLeaderboardOptimistic(member) {
        const tbody = document.getElementById('leaderboardBody');
        const tempId = 'temp-' + Date.now();
        const row = document.createElement('tr');
        row.id = 'member-' + tempId;
        row.dataset.tempId = tempId;
        row.style.opacity = '0.7';
        row.innerHTML = `
            <td>-</td>
            <td><strong>${member.name}</strong>${member.is_custom_calc ? ' <span style="color: #95a5a6; font-size: 0.75rem;">(å®¢)</span>' : ''}</td>
            <td class="score">${parseFloat(member.total_score || 0).toFixed(2)}</td>
            <td>${member.completed_routes_count || 0}</td>
            <td>
                <button class="btn btn-primary btn-small" disabled>ç·¨è¼¯</button>
            </td>
        `;
        tbody.appendChild(row);
        return tempId;
    }

    // ç§»é™¤ä¸´æ—¶æˆå‘˜
    function removeTempMember(tempId) {
        const row = document.querySelector(`tr[data-temp-id="${tempId}"]`);
        if (row) {
            row.remove();
        }
    }

    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(function(dropdown) {
                dropdown.style.display = 'none';
            });
        }
    });
    
    // é é¢è¼‰å…¥æ™‚ç²å–æ’è¡Œæ¦œå’Œè·¯ç·šåˆ—è¡¨
    // æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹çš„è¼”åŠ©å‡½æ•¸
    function checkAuthentication() {
        return fetch('/api/auth/current-user/', {
            credentials: 'include'
        })
        .then(response => {
            if (response.ok) {
                return response.json().then(user => ({ authenticated: true, user }));
            } else {
                return { authenticated: false, user: null };
            }
        })
        .catch(error => {
            console.error('æª¢æŸ¥èªè­‰ç‹€æ…‹å¤±æ•—:', error);
            return { authenticated: false, user: null };
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // æª¢æŸ¥èªè­‰ç‹€æ…‹ï¼ˆåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­å¾ˆé‡è¦ï¼‰
        checkAuthentication().then(authStatus => {
            if (!authStatus.authenticated) {
                console.warn('ç”¨æˆ¶æœªèªè­‰ï¼ŒæŸäº›æ“ä½œå¯èƒ½éœ€è¦ç™»éŒ„');
                // åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œå¯ä»¥é¸æ“‡é‡å®šå‘åˆ°ç™»éŒ„é é¢
                // ä½†åœ¨é–‹ç™¼ç’°å¢ƒä¸­ï¼Œå…è¨±æœªèªè­‰ç”¨æˆ¶è¨ªå•ï¼ˆå› ç‚º DEBUG=True æ™‚ä½¿ç”¨ AllowAnyï¼‰
            }
        });
        
        loadLeaderboard();
        loadMembersForRouteForm();
        loadRoutes();
    });

    function loadLeaderboard() {
        // æ·»åŠ æ™‚é–“æˆ³é˜²æ­¢ç·©å­˜
        const timestamp = new Date().getTime();
        fetch(`/api/rooms/${ROOM_ID}/leaderboard/?_t=${timestamp}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayLeaderboard(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
                document.getElementById('leaderboardBody').innerHTML = 
                    '<tr><td colspan="5" class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</td></tr>';
            });
    }

    function displayLeaderboard(data) {
        const roomInfo = data.room_info;
        const leaderboard = data.leaderboard;

        // æ›´æ–°æˆ¿é–“è³‡è¨Šä¸¦è¨­ç½®æ­£ç¢ºçš„æˆ¿é–“ ID
        ROOM_ID = roomInfo.id; // å¾ API ç²å–å¯¦éš›çš„æˆ¿é–“ ID
        document.getElementById('roomName').textContent = roomInfo.name;
        document.getElementById('roomIdDisplay').textContent = roomInfo.id;
        document.getElementById('standardLineScore').textContent = roomInfo.standard_line_score;
        
        // åŒæ™‚æ›´æ–°ç§»å‹•ç«¯æˆ¿é–“æ¨™é¡Œï¼ˆä¸å†é¡¯ç¤ºæˆ¿é–“åç¨±ï¼Œæ”¹ç‚ºåœ¨æ’è¡Œæ¦œæ¨™é¡Œä¸­é¡¯ç¤ºï¼‰
        document.getElementById('roomIdDisplayMobile').textContent = roomInfo.id;
        document.getElementById('standardLineScoreMobile').textContent = roomInfo.standard_line_score;
        
        // åœ¨æ’è¡Œæ¦œæ¨™é¡Œå³å´é¡¯ç¤ºæˆ¿é–“åç¨±ï¼ˆå°å­—é«”ï¼‰
        const roomTitleInline = document.getElementById('roomTitleInline');
        if (roomTitleInline) {
            roomTitleInline.textContent = ' ' + roomInfo.name;
        }
        
        // æ›´æ–°å°èˆªæ¬„ä¸­çš„æˆ¿é–“è³‡è¨Š
        const navbarRoomInfo = document.getElementById('navbarRoomInfo');
        const navbarRoomId = document.getElementById('navbarRoomId');
        const navbarStandardLineScore = document.getElementById('navbarStandardLineScore');
        if (navbarRoomInfo && navbarRoomId && navbarStandardLineScore) {
            navbarRoomId.textContent = roomInfo.id;
            navbarStandardLineScore.textContent = roomInfo.standard_line_score;
            navbarRoomInfo.style.display = 'flex';
        }
        
        // æ›´æ–°ç·¨è¼¯æˆ¿é–“è¡¨å–®çš„é è¨­å€¼
        document.getElementById('editRoomId').value = roomInfo.id;
        document.getElementById('editRoomName').value = roomInfo.name;
        document.getElementById('editRoomStandardLineScore').value = roomInfo.standard_line_score;

        // æ›´æ–°æ’è¡Œæ¦œ
        const tbody = document.getElementById('leaderboardBody');
        if (leaderboard.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty">å°šç„¡æˆå“¡æ•¸æ“š</td></tr>';
            return;
        }

        tbody.innerHTML = leaderboard.map((member, index) => {
            const rank = index + 1;
            const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
            return `
                <tr class="${rankClass}">
                    <td>${rankIcon ? rankIcon + ' ' : ''}${rank}</td>
                    <td><strong>${member.name}</strong>${member.is_custom_calc ? ' <span style="color: #95a5a6; font-size: 0.75rem; font-weight: normal;">(å®¢)</span>' : ''}</td>
                    <td class="score">${parseFloat(member.total_score).toFixed(2)}</td>
                    <td>
                        <a href="#" class="completed-routes-link" onclick="showCompletedRoutes(${member.id}, '${member.name.replace(/'/g, "\\'")}'); return false;" title="é»æ“ŠæŸ¥çœ‹å®Œæˆçš„è·¯ç·š">
                            ${member.completed_routes_count}
                        </a>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editMember(${member.id}, '${member.name}', ${member.is_custom_calc})" title="ç·¨è¼¯æˆå“¡">
                            ç·¨è¼¯
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function refreshLeaderboard(updateOnly = false) {
        if (updateOnly) {
            // åªæ›´æ–°æ’è¡Œæ¦œï¼Œä¸é‡æ–°åŠ è½½è·¯çº¿åˆ—è¡¨ï¼ˆæ›´å¿«ï¼‰
            loadLeaderboard();
        } else {
            // å®Œæ•´åˆ·æ–°ï¼šå…ˆé‡æ–°è¼‰å…¥è·¯ç·šåˆ—è¡¨ï¼Œç¢ºä¿æ•¸æ“šåŒæ­¥
            loadRoutes();
            // ç„¶å¾Œè¼‰å…¥æ’è¡Œæ¦œ
            loadLeaderboard();
        }
    }

    function showCompletedRoutes(memberId, memberName) {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('completedRoutesModalTitle').textContent = `${memberName} å®Œæˆçš„è·¯ç·š`;
        document.getElementById('completedRoutesList').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        document.getElementById('completedRoutesModal').style.display = 'block';
        
        // ç²å–æˆå“¡å®Œæˆçš„è·¯ç·š
        fetch(`/api/members/${memberId}/completed-routes/`)
            .then(response => response.json())
            .then(data => {
                displayCompletedRoutes(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥å®Œæˆè·¯ç·šå¤±æ•—:', error);
                document.getElementById('completedRoutesList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦</div>';
            });
    }

    function displayCompletedRoutes(data) {
        const container = document.getElementById('completedRoutesList');
        const routes = data.completed_routes || [];
        
        if (routes.length === 0) {
            container.innerHTML = '<div class="empty">è©²æˆå“¡å°šæœªå®Œæˆä»»ä½•è·¯ç·š</div>';
            return;
        }
        
        container.innerHTML = routes.map(route => {
            const routeName = route.name || 'æœªå‘½åè·¯ç·š';
            const grade = route.grade || '-';
            const photoUrl = route.photo_url || '';
            // è½‰ç¾© URL å’Œåç¨±ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            const safePhotoUrl = photoUrl ? photoUrl.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
            const safeRouteName = routeName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            // çµ±è¨ˆå®Œæˆäººæ•¸
            const scores = route.scores || [];
            const completedCount = scores.filter(s => s.is_completed).length;
            const totalCount = scores.length;
            
            return `
                <div class="completed-route-item">
                    <div class="completed-route-header">
                        <div class="completed-route-info">
                            <strong>${routeName}</strong>
                            <span class="route-grade-badge">${grade}</span>
                        </div>
                        <div class="completed-route-stats">
                            å®Œæˆæ¢æ•¸: ${completedCount}/${totalCount} äºº
                        </div>
                    </div>
                    ${photoUrl ? `<div class="completed-route-photo"><img src="${safePhotoUrl}" alt="${safeRouteName}" style="max-width: 100%; border-radius: 4px; margin-top: 10px;" onerror="this.style.display='none'; console.error('ç…§ç‰‡è¼‰å…¥å¤±æ•—ï¼ŒURL:', '${safePhotoUrl}');"></div>` : ''}
                </div>
            `;
        }).join('');
    }

    function closeCompletedRoutesModal() {
        document.getElementById('completedRoutesModal').style.display = 'none';
    }

    function showPhotoModal(photoUrl, routeName) {
        document.getElementById('photoModalTitle').textContent = routeName || 'è·¯ç·šåœ–ç‰‡';
        document.getElementById('photoModalImage').src = photoUrl;
        document.getElementById('photoModalImage').alt = routeName || 'è·¯ç·šåœ–ç‰‡';
        document.getElementById('photoModal').style.display = 'block';
    }

    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }

    function loadRoutes() {
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                displayRoutes(data.routes || []);
            })
            .catch(error => {
                console.error('è¼‰å…¥è·¯ç·šåˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('routesList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</div>';
            });
    }

    function displayRoutes(routes) {
        const container = document.getElementById('routesList');
        
        if (!routes || routes.length === 0) {
            container.innerHTML = '<div class="empty">å°šç„¡è·¯ç·šï¼Œè«‹å‰µå»ºè·¯ç·š</div>';
            return;
        }

        container.innerHTML = routes.map(route => {
            // çµ±è¨ˆå®Œæˆäººæ•¸
            const completedCount = route.scores ? route.scores.filter(s => s.is_completed).length : 0;
            const totalCount = route.scores ? route.scores.length : 0;
            
            // åœ¨è·¯ç·šåç¨±å‰åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´
            const routeDisplayName = route.name.startsWith('ã€è·¯ç·šã€‘') 
                ? route.name 
                : 'ã€è·¯ç·šã€‘' + route.name;
            
            // å¦‚æœæœ‰åœ–ç‰‡ï¼Œé¡¯ç¤ºç¸®åœ–
            const photoUrl = route.photo_url || '';
            // è½‰ç¾© URL å’Œåç¨±ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ JavaScript éŒ¯èª¤
            const safePhotoUrl = photoUrl ? photoUrl.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
            const safeRouteName = routeDisplayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const photoThumbnail = photoUrl ? `
                <img src="${safePhotoUrl}" alt="${safeRouteName}" class="route-photo-thumbnail" 
                     onclick="showPhotoModal('${safePhotoUrl}', '${safeRouteName}')" 
                     title="é»æ“ŠæŸ¥çœ‹å¤§åœ–"
                     onerror="this.style.display='none'; console.error('ç…§ç‰‡è¼‰å…¥å¤±æ•—ï¼ŒURL:', '${safePhotoUrl}');">
            ` : '';
            
            return `
                <div class="route-item">
                    <div class="route-info">
                        <div class="route-name-grade">
                            <strong>${routeDisplayName}</strong>
                            ${route.grade ? `<span class="route-grade">${route.grade}</span>` : ''}
                            ${photoThumbnail}
                        </div>
                        <div class="route-stats">
                            å®Œæˆæ¢æ•¸: ${completedCount}/${totalCount} äºº
                        </div>
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-primary btn-small" onclick="editRoute(${route.id})">
                            ç·¨è¼¯
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editRoute(routeId) {
        // ç²å–è·¯ç·šè©³æƒ…
        fetch(`/api/routes/${routeId}/`)
            .then(response => response.json())
            .then(route => {
                showEditRouteModal(route);
            })
            .catch(error => {
                console.error('è¼‰å…¥è·¯ç·šè©³æƒ…å¤±æ•—:', error);
                showToast('è¼‰å…¥è·¯ç·šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            });
    }

    function showEditRouteModal(route) {
        // ä¿å­˜åŸå§‹è·¯ç·šåç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        const originalRouteName = route.name || '';
        
        // å¡«å……è¡¨å–®ï¼ˆç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ä»¥ä¾¿ç·¨è¼¯ï¼‰
        let routeNameForEdit = originalRouteName;
        // ç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ï¼ˆ4å€‹å­—ç¬¦ï¼šã€ã€è·¯ã€ç·šã€ã€‘ï¼‰
        if (routeNameForEdit.startsWith('ã€è·¯ç·šã€‘')) {
            routeNameForEdit = routeNameForEdit.substring(4); // ç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ï¼ˆ4å€‹å­—ç¬¦ï¼‰
        }
        // å¦‚æœç§»é™¤å¾Œçš„åç¨±ä¸åŒ…å«"è·¯ç·š"ä½†åªæ˜¯ä¸€å€‹æ•¸å­—ï¼Œæ·»åŠ "è·¯ç·š"å‰ç¶´
        // ä¾‹å¦‚ï¼š"ç·š3" -> "è·¯ç·š3"ï¼Œ"3" -> "è·¯ç·š3"
        if (routeNameForEdit && !routeNameForEdit.includes('è·¯ç·š') && /^[ç·šè·¯\d]+$/.test(routeNameForEdit)) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„"ç·š"æˆ–"è·¯"å­—ç¬¦ï¼Œç„¶å¾Œæ·»åŠ "è·¯ç·š"
            routeNameForEdit = routeNameForEdit.replace(/^[ç·šè·¯]*/, '');
            if (routeNameForEdit && /^\d+$/.test(routeNameForEdit)) {
                routeNameForEdit = 'è·¯ç·š' + routeNameForEdit;
            } else if (!routeNameForEdit || routeNameForEdit === '') {
                // å¦‚æœå®Œå…¨ç§»é™¤å¾Œç‚ºç©ºï¼Œä¿æŒåŸæ¨£æˆ–æ·»åŠ é è¨­å€¼
                routeNameForEdit = 'è·¯ç·š1';
            }
        }
        
        currentEditingRouteId = route.id;
        // ä¿å­˜åŸå§‹åç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰å’Œç·¨è¼¯ç”¨çš„åç¨±ï¼ˆä¸åŒ…å«å‰ç¶´ï¼‰
        currentEditingRouteName = originalRouteName; // ä¿å­˜åŸå§‹å®Œæ•´åç¨±
        document.getElementById('editRouteId').value = route.id;
        document.getElementById('editRouteName').value = routeNameForEdit;
        document.getElementById('editRouteGrade').value = route.grade || '';
        
        // æ›´æ–°é è¦½å€åŸŸï¼ˆé¡¯ç¤ºç¾æœ‰ç…§ç‰‡ï¼‰
        const photoPreview = document.getElementById('editRoutePhotoPreview');
        if (route.photo_url) {
            // è½‰ç¾© URL ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            const safePhotoUrl = route.photo_url.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            photoPreview.innerHTML = `
                <div style="margin-top: 10px;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 5px;">ç›®å‰ç…§ç‰‡:</p>
                    <img id="editRoutePhotoPreviewImg" src="${safePhotoUrl}" alt="è·¯ç·šç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;" onerror="this.style.display='none'; console.error('ç…§ç‰‡è¼‰å…¥å¤±æ•—ï¼ŒURL:', '${safePhotoUrl}');">
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">é¸æ“‡æ–°ç…§ç‰‡å°‡æ›¿æ›ç¾æœ‰ç…§ç‰‡</p>
                </div>
            `;
        } else {
            photoPreview.innerHTML = '';
        }
        
        // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥ï¼ˆå› ç‚ºæ–‡ä»¶è¼¸å…¥ç„¡æ³•è¨­ç½®å€¼ï¼‰
        const editPhotoInput = document.getElementById('editRoutePhoto');
        const editPhotoFromGallery = document.getElementById('editRoutePhotoFromGallery');
        
        // çµ±ä¸€çš„ change äº‹ä»¶è™•ç†å‡½æ•¸ï¼ˆç”¨æ–¼ç·¨è¼¯è·¯ç·šï¼‰
        const handleEditPhotoChange = function(inputElement) {
            if (inputElement && inputElement.files && inputElement.files[0]) {
                // åŒæ­¥åˆ°å¦ä¸€å€‹è¼¸å…¥æ¡†
                const otherInput = inputElement.id === 'editRoutePhotoFromGallery' ? editPhotoInput : editPhotoFromGallery;
                if (otherInput) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(inputElement.files[0]);
                    otherInput.files = dataTransfer.files;
                }
                // æ›´æ–°é è¦½ï¼ˆå¦‚æœå·²æœ‰ç…§ç‰‡ï¼Œé¡¯ç¤ºæ–°ç…§ç‰‡ï¼‰
                // å…ˆæª¢æŸ¥é è¦½å€åŸŸæ˜¯å¦æœ‰ç¾æœ‰ç…§ç‰‡çµæ§‹
                const photoPreview = document.getElementById('editRoutePhotoPreview');
                if (photoPreview) {
                    const existingImg = document.getElementById('editRoutePhotoPreviewImg');
                    // å¦‚æœæ²’æœ‰é è¦½åœ–ç‰‡å…ƒç´ ï¼Œå‰µå»ºé è¦½çµæ§‹
                    if (!existingImg) {
                        photoPreview.innerHTML = `
                            <div style="margin-top: 10px;">
                                <p style="font-size: 14px; color: #666; margin-bottom: 5px;">æ–°é¸æ“‡çš„ç…§ç‰‡:</p>
                                <img id="editRoutePhotoPreviewImg" src="" alt="è·¯ç·šç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">
                                <p style="font-size: 12px; color: #999; margin-top: 5px;">é¸æ“‡æ–°ç…§ç‰‡å°‡æ›¿æ›ç¾æœ‰ç…§ç‰‡</p>
                            </div>
                        `;
                    } else {
                        // å¦‚æœæœ‰ç¾æœ‰ç…§ç‰‡ï¼Œæ›´æ–°æ¨™é¡Œ
                        const titleElement = photoPreview.querySelector('p');
                        if (titleElement && titleElement.textContent.includes('ç›®å‰ç…§ç‰‡')) {
                            titleElement.textContent = 'æ–°é¸æ“‡çš„ç…§ç‰‡:';
                        }
                    }
                }
                // é¡¯ç¤ºæ–°ç…§ç‰‡é è¦½
                showPhotoPreview(inputElement, 'editRoutePhotoPreview', 'editRoutePhotoPreviewImg');
            }
        };
        
        if (editPhotoInput) {
            editPhotoInput.value = '';
            editPhotoInput.onchange = function() {
                handleEditPhotoChange(this);
            };
        }
        
        if (editPhotoFromGallery) {
            editPhotoFromGallery.value = '';
            editPhotoFromGallery.onchange = function() {
                handleEditPhotoChange(this);
            };
        }
        
        // å¡«å……æˆå“¡å®Œæˆç‹€æ…‹
        const container = document.getElementById('editMemberCompletions');
        loadMembersForEditRouteForm(container, route.scores || []);
        
        // é¡¯ç¤ºå½ˆçª—
        document.getElementById('editRouteModal').style.display = 'block';
    }

    let currentEditingRouteId = null;
    let currentEditingRouteName = null;

    function closeEditRouteModal() {
        document.getElementById('editRouteModal').style.display = 'none';
        document.getElementById('editRouteForm').reset();
        currentEditingRouteId = null;
        currentEditingRouteName = null;
    }

    function deleteRouteFromEditModal() {
        const routeId = document.getElementById('editRouteId').value;
        const routeName = document.getElementById('editRouteName').value || 'æ­¤è·¯ç·š';
        
        if (!routeId) {
            showToast('éŒ¯èª¤ï¼šç„¡æ³•ç²å–è·¯ç·šè³‡è¨Š', 'error');
            return;
        }
        
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤è·¯ç·š "${routeName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²è·¯ç·šçš„æ‰€æœ‰æˆç¸¾è¨˜éŒ„ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }
        
        // é—œé–‰ç·¨è¼¯å½ˆçª—
        closeEditRouteModal();
        
        // åŸ·è¡Œåˆªé™¤è·¯ç·šæ“ä½œ
        fetch(`/api/routes/${routeId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include'
        })
        .then(response => {
            if (response.status === 204 || response.ok) {
                showToast('è·¯ç·šå·²åˆªé™¤', 'success');
                // ç«‹å³é‡æ–°è¼‰å…¥è·¯ç·šåˆ—è¡¨ï¼Œè®“è©²è·¯ç·šæ¶ˆå¤±
                loadRoutes();
                refreshLeaderboard(true);
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤è·¯ç·šå¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            showToast('åˆªé™¤è·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
        });
    }

    function loadMembersForEditRouteForm(container, scores) {
        // å°‡åˆ†æ•¸è¨˜éŒ„è½‰æ›ç‚ºå­—å…¸ï¼Œä¾¿æ–¼æŸ¥æ‰¾
        const scoreMap = {};
        scores.forEach(score => {
            scoreMap[score.member_id] = score.is_completed;
        });

        // ç²å–æˆå“¡åˆ—è¡¨ä¸¦é¡¯ç¤º
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = (data.members || []).map(member => {
                    const isCompleted = scoreMap[member.id] || false;
                    return `
                        <label class="member-checkbox">
                            <input type="checkbox" name="member_${member.id}" value="${member.id}" ${isCompleted ? 'checked' : ''}>
                            ${member.name} ${member.is_custom_calc ? '(Y)' : '(N)'}
                        </label>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—:', error);
            });
    }
    

    function loadMembersForRouteForm() {
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                displayMembersForForm(data.members);
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—:', error);
            });
    }

    function displayMembersForForm(members) {
        const container = document.getElementById('memberCompletions');
        container.innerHTML = members.map(member => {
            return `
                <label class="member-checkbox">
                    <input type="checkbox" name="member_${member.id}" value="${member.id}">
                    ${member.name} ${member.is_custom_calc ? '(Y)' : '(N)'}
                </label>
            `;
        }).join('');
    }

    function showAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'block';
        // è‡ªå‹•èšç„¦åˆ°æˆå“¡åç¨±è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ç›´æ¥è¼¸å…¥
        setTimeout(function() {
            const memberNameInput = document.getElementById('memberName');
            if (memberNameInput) {
                memberNameInput.focus();
            }
        }, 100); // ç¨å»¶é²ç¢ºä¿å½ˆçª—å·²å®Œå…¨é¡¯ç¤º
    }

    function closeAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'none';
        document.getElementById('addMemberForm').reset();
    }

    let currentEditingMemberId = null;
    let currentEditingMemberName = null;

    function editMember(memberId, memberName, isCustomCalc) {
        currentEditingMemberId = memberId;
        currentEditingMemberName = memberName;
        document.getElementById('editMemberId').value = memberId;
        document.getElementById('editMemberName').value = memberName;
        document.getElementById('editIsCustomCalc').checked = isCustomCalc;
        document.getElementById('editMemberModal').style.display = 'block';
    }

    function closeEditMemberModal() {
        document.getElementById('editMemberModal').style.display = 'none';
        document.getElementById('editMemberForm').reset();
        currentEditingMemberId = null;
        currentEditingMemberName = null;
    }

    function deleteMemberFromEditModal() {
        if (!currentEditingMemberId || !currentEditingMemberName) {
            showToast('éŒ¯èª¤ï¼šç„¡æ³•ç²å–æˆå“¡è³‡è¨Š', 'error');
            return;
        }
        
        // ä¿å­˜æˆå“¡ä¿¡æ¯ï¼ˆåœ¨é—œé–‰å½ˆçª—å‰ï¼‰
        const memberId = currentEditingMemberId;
        const memberName = currentEditingMemberName;
        
        // é—œé–‰ç·¨è¼¯å½ˆçª—
        closeEditMemberModal();
        
        // åŸ·è¡Œåˆªé™¤æ“ä½œï¼ˆä½¿ç”¨ä¿å­˜çš„è®Šæ•¸ï¼Œè€Œä¸æ˜¯å¯èƒ½å·²è¢«æ¸…ç©ºçš„å…¨å±€è®Šæ•¸ï¼‰
        deleteMember(memberId, memberName);
    }

    function deleteMember(memberId, memberName) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤æˆå“¡ "${memberName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²æˆå“¡çš„æ‰€æœ‰æˆç¸¾è¨˜éŒ„ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }

        // ç²å– CSRF token
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            showToast('ç„¡æ³•ç²å–å®‰å…¨ä»¤ç‰Œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦', 'error');
            return;
        }

        fetch(`/api/members/${memberId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            credentials: 'include'
        })
        .then(response => {
            console.log('åˆªé™¤æˆå“¡éŸ¿æ‡‰ç‹€æ…‹:', response.status);
            if (response.status === 204 || response.ok) {
                showToast('æˆå“¡å·²åˆªé™¤', 'success');
                // å¼·åˆ¶åˆ·æ–°æ’è¡Œæ¦œï¼ˆä¸ä½¿ç”¨ç·©å­˜ï¼‰
                // å…ˆé—œé–‰ç·¨è¼¯å½ˆçª—ï¼ˆå¦‚æœé‚„é–‹è‘—ï¼‰
                closeEditMemberModal();
                // ç«‹å³åˆ·æ–°æ’è¡Œæ¦œ
                loadLeaderboard();
                // åˆ·æ–°æˆå“¡åˆ—è¡¨ä¾›è·¯ç·šè¡¨å–®ä½¿ç”¨
                loadMembersForRouteForm();
            } else if (response.status === 404) {
                // æˆå“¡ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²è¢«åˆªé™¤ï¼‰
                return response.json().then(err => {
                    const errorMsg = err.detail || 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æˆå“¡';
                    showToast('åˆªé™¤æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
                    // åˆ·æ–°åˆ—è¡¨ï¼Œå¯èƒ½æˆå“¡å·²è¢«åˆªé™¤
                    closeEditMemberModal();
                    loadLeaderboard();
                    loadMembersForRouteForm();
                });
            } else if (response.status === 403 || response.status === 401) {
                // æ¬Šé™å•é¡Œ
                return response.json().then(err => {
                    const errorMsg = err.detail || 'æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œï¼Œè«‹ç¢ºèªå·²ç™»éŒ„';
                    showToast('åˆªé™¤æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
                });
            } else {
                // å…¶ä»–éŒ¯èª¤
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤æˆå“¡å¤±æ•—:', error);
            let errorMsg = 'åˆªé™¤æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤';
            
            if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.error) {
                errorMsg = error.error;
            }
            
            showToast('åˆªé™¤æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
            // å³ä½¿å‡ºéŒ¯ä¹Ÿåˆ·æ–°æ’è¡Œæ¦œï¼Œç¢ºä¿æ•¸æ“šåŒæ­¥
            closeEditMemberModal();
            loadLeaderboard();
            loadMembersForRouteForm();
        });
    }

    // è§¸ç™¼ç…§ç‰‡é¸æ“‡ï¼ˆæ”¯æŒæ‹ç…§å’Œåœ–åº«é¸æ“‡ï¼‰
    function triggerGallerySelect() {
        const routePhotoFromGallery = document.getElementById('routePhotoFromGallery');
        const routePhotoInput = document.getElementById('routePhoto');
        
        // ç¢ºä¿äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®ï¼ˆå¦‚æœé‚„æ²’æœ‰è¨­ç½®ï¼‰
        // é€™å°æ–¼ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚å¾ˆé‡è¦
        if (routePhotoInput && !routePhotoInput.onchange) {
            const handlePhotoChange = function(inputElement) {
                if (inputElement && inputElement.files && inputElement.files[0]) {
                    const otherInput = inputElement.id === 'routePhotoFromGallery' ? routePhotoInput : routePhotoFromGallery;
                    if (otherInput) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(inputElement.files[0]);
                        otherInput.files = dataTransfer.files;
                    }
                    showPhotoPreview(inputElement, 'routePhotoPreview', 'routePhotoPreviewImg');
                }
            };
            routePhotoInput.onchange = function() {
                handlePhotoChange(this);
            };
        }
        
        if (routePhotoFromGallery && !routePhotoFromGallery.onchange) {
            const handlePhotoChange = function(inputElement) {
                if (inputElement && inputElement.files && inputElement.files[0]) {
                    const otherInput = inputElement.id === 'routePhotoFromGallery' ? routePhotoInput : routePhotoFromGallery;
                    if (otherInput) {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(inputElement.files[0]);
                        otherInput.files = dataTransfer.files;
                    }
                    showPhotoPreview(inputElement, 'routePhotoPreview', 'routePhotoPreviewImg');
                }
            };
            routePhotoFromGallery.onchange = function() {
                handlePhotoChange(this);
            };
        }
        
        // å„ªå…ˆä½¿ç”¨åœ–åº«é¸æ“‡è¼¸å…¥æ¡†ï¼Œä½†ä¹Ÿè¦ç¢ºä¿æ‹ç…§è¼¸å…¥æ¡†æœ‰äº‹ä»¶ç›£è½
        if (routePhotoFromGallery) {
            // åœ¨ç§»å‹•è¨­å‚™ä¸Šï¼Œæ–‡ä»¶é¸æ“‡å™¨æœƒè‡ªå‹•æä¾›æ‹ç…§å’Œåœ–åº«é¸æ“‡é¸é …
            // ä¸éœ€è¦è¨­ç½® capture å±¬æ€§ï¼Œè®“ç”¨æˆ¶è‡ªå·±é¸æ“‡
            routePhotoFromGallery.click();
        } else if (routePhotoInput) {
            // å¦‚æœåœ–åº«é¸æ“‡è¼¸å…¥æ¡†ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ‹ç…§è¼¸å…¥æ¡†
            routePhotoInput.click();
        }
    }
    
    // æ¸…é™¤è·¯ç·šç…§ç‰‡
    function clearRoutePhoto() {
        const routePhotoInput = document.getElementById('routePhoto');
        const routePhotoFromGallery = document.getElementById('routePhotoFromGallery');
        const preview = document.getElementById('routePhotoPreview');
        
        if (routePhotoInput) routePhotoInput.value = '';
        if (routePhotoFromGallery) routePhotoFromGallery.value = '';
        if (preview) preview.style.display = 'none';
    }
    
    // ç·¨è¼¯è·¯ç·šï¼šè§¸ç™¼ç…§ç‰‡é¸æ“‡ï¼ˆæ”¯æŒæ‹ç…§å’Œåœ–åº«é¸æ“‡ï¼‰
    function triggerEditGallerySelect() {
        const editRoutePhotoFromGallery = document.getElementById('editRoutePhotoFromGallery');
        const editRoutePhotoInput = document.getElementById('editRoutePhoto');
        
        // å„ªå…ˆä½¿ç”¨åœ–åº«é¸æ“‡è¼¸å…¥æ¡†ï¼Œä½†ä¹Ÿè¦ç¢ºä¿æ‹ç…§è¼¸å…¥æ¡†æœ‰äº‹ä»¶ç›£è½
        if (editRoutePhotoFromGallery) {
            // åœ¨ç§»å‹•è¨­å‚™ä¸Šï¼Œæ–‡ä»¶é¸æ“‡å™¨æœƒè‡ªå‹•æä¾›æ‹ç…§å’Œåœ–åº«é¸æ“‡é¸é …
            // ä¸éœ€è¦è¨­ç½® capture å±¬æ€§ï¼Œè®“ç”¨æˆ¶è‡ªå·±é¸æ“‡
            editRoutePhotoFromGallery.click();
        } else if (editRoutePhotoInput) {
            // å¦‚æœåœ–åº«é¸æ“‡è¼¸å…¥æ¡†ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ‹ç…§è¼¸å…¥æ¡†
            editRoutePhotoInput.click();
        }
    }
    
    // é¡¯ç¤ºç…§ç‰‡é è¦½
    function showPhotoPreview(input, previewId, previewImgId) {
        if (!input) {
            console.warn('showPhotoPreview: input å…ƒç´ ä¸å­˜åœ¨');
            return;
        }
        
        if (!input.files || !input.files[0]) {
            console.warn('showPhotoPreview: æ²’æœ‰é¸æ“‡ç…§ç‰‡æ–‡ä»¶', { 
                input: !!input, 
                files: input.files ? input.files.length : 0,
                firstFile: input.files && input.files[0] ? input.files[0].name : 'N/A'
            });
            return;
        }
        
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById(previewId);
            let previewImg = document.getElementById(previewImgId);
            
            // å¦‚æœé è¦½åœ–ç‰‡å…ƒç´ ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºå®ƒ
            if (preview && !previewImg) {
                // æª¢æŸ¥é è¦½å®¹å™¨æ˜¯å¦æœ‰å…§å®¹
                if (preview.innerHTML.trim() === '') {
                    // å‰µå»ºé è¦½çµæ§‹ï¼ˆç”¨æ–¼æ–°å¢è·¯ç·šï¼‰
                    preview.innerHTML = `
                        <img id="${previewImgId}" src="" alt="ç…§ç‰‡é è¦½" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">
                    `;
                    previewImg = document.getElementById(previewImgId);
                } else {
                    // å¦‚æœé è¦½å®¹å™¨æœ‰å…§å®¹ä½†æ²’æœ‰åœ–ç‰‡å…ƒç´ ï¼Œå˜—è©¦æŸ¥æ‰¾æˆ–å‰µå»º
                    previewImg = preview.querySelector('img');
                    if (!previewImg) {
                        const img = document.createElement('img');
                        img.id = previewImgId;
                        img.alt = 'ç…§ç‰‡é è¦½';
                        img.style.cssText = 'max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;';
                        preview.appendChild(img);
                        previewImg = img;
                    } else {
                        // å¦‚æœæ‰¾åˆ°äº†åœ–ç‰‡å…ƒç´ ä½†æ²’æœ‰ IDï¼Œè¨­ç½® ID
                        if (!previewImg.id) {
                            previewImg.id = previewImgId;
                        }
                    }
                }
            }
            
            if (preview && previewImg) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                // ç¢ºä¿åœ–ç‰‡å…ƒç´ å¯è¦‹
                if (previewImg.style.display === 'none') {
                    previewImg.style.display = 'block';
                }
                // ç¢ºä¿åœ–ç‰‡å…ƒç´ æœ‰æ­£ç¢ºçš„æ¨£å¼
                if (!previewImg.style.maxWidth) {
                    previewImg.style.maxWidth = '200px';
                }
                if (!previewImg.style.maxHeight) {
                    previewImg.style.maxHeight = '200px';
                }
                console.log('ç…§ç‰‡é è¦½å·²é¡¯ç¤ºï¼Œæ–‡ä»¶å:', file.name, 'å¤§å°:', file.size, 'é¡å‹:', file.type);
            } else {
                console.error('é è¦½å…ƒç´ æœªæ‰¾åˆ°:', { 
                    previewId, 
                    previewImgId, 
                    preview: !!preview, 
                    previewImg: !!previewImg,
                    previewHTML: preview ? preview.innerHTML.substring(0, 100) : 'N/A'
                });
            }
        };
        
        reader.onerror = function(error) {
            console.error('è®€å–ç…§ç‰‡æ–‡ä»¶å¤±æ•—:', error, 'æ–‡ä»¶å:', file.name, 'å¤§å°:', file.size, 'é¡å‹:', file.type);
        };
        
        // ç¢ºä¿æ–‡ä»¶æŒ‡é‡åœ¨é–‹å§‹ä½ç½®
        if (file && file.size > 0) {
            reader.readAsDataURL(file);
        } else {
            console.error('æ–‡ä»¶ç„¡æ•ˆæˆ–ç‚ºç©º:', { name: file.name, size: file.size, type: file.type });
        }
    }
    
    function showAddRouteModal() {
        document.getElementById('addRouteModal').style.display = 'block';
        // è¨­ç½®è·¯ç·šåç¨±é è¨­å€¼ï¼ˆè·¯ç·š1ã€è·¯ç·š2ç­‰ï¼‰
        setTimeout(function() {
            setupRouteNameExample();
        }, 100);
        // é‡ç½®ç…§ç‰‡é è¦½
        clearRoutePhoto();
        
        // è¨­ç½®æ–‡ä»¶è¼¸å…¥æ¡†çš„ change äº‹ä»¶ç›£è½å™¨
        const routePhotoInput = document.getElementById('routePhoto');
        const routePhotoFromGallery = document.getElementById('routePhotoFromGallery');
        
        // çµ±ä¸€çš„ change äº‹ä»¶è™•ç†å‡½æ•¸
        const handlePhotoChange = function(inputElement) {
            if (inputElement && inputElement.files && inputElement.files[0]) {
                console.log('æ–‡ä»¶é¸æ“‡äº‹ä»¶è§¸ç™¼:', {
                    inputId: inputElement.id,
                    fileName: inputElement.files[0].name,
                    fileSize: inputElement.files[0].size,
                    fileType: inputElement.files[0].type
                });
                
                // åŒæ­¥åˆ°å¦ä¸€å€‹è¼¸å…¥æ¡†
                const otherInput = inputElement.id === 'routePhotoFromGallery' ? routePhotoInput : routePhotoFromGallery;
                if (otherInput) {
                    try {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(inputElement.files[0]);
                        otherInput.files = dataTransfer.files;
                        console.log('æ–‡ä»¶å·²åŒæ­¥åˆ°å¦ä¸€å€‹è¼¸å…¥æ¡†:', otherInput.id);
                    } catch (error) {
                        console.error('åŒæ­¥æ–‡ä»¶åˆ°å¦ä¸€å€‹è¼¸å…¥æ¡†å¤±æ•—:', error);
                    }
                }
                // é¡¯ç¤ºé è¦½
                showPhotoPreview(inputElement, 'routePhotoPreview', 'routePhotoPreviewImg');
            } else {
                console.warn('handlePhotoChange: æ²’æœ‰æœ‰æ•ˆçš„æ–‡ä»¶', {
                    inputElement: !!inputElement,
                    files: inputElement ? (inputElement.files ? inputElement.files.length : 0) : 0
                });
            }
        };
        
        // ç‚ºå…©å€‹è¼¸å…¥æ¡†éƒ½è¨­ç½®äº‹ä»¶ç›£è½å™¨ï¼ˆç¢ºä¿æ¯æ¬¡æ‰“é–‹å½ˆçª—æ™‚éƒ½é‡æ–°è¨­ç½®ï¼‰
        if (routePhotoInput) {
            // å…ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            routePhotoInput.onchange = null;
            // è¨­ç½®æ–°çš„äº‹ä»¶ç›£è½å™¨
            routePhotoInput.onchange = function() {
                handlePhotoChange(this);
            };
            console.log('å·²ç‚º routePhotoInput è¨­ç½®äº‹ä»¶ç›£è½å™¨');
        }
        
        if (routePhotoFromGallery) {
            // å…ˆç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            routePhotoFromGallery.onchange = null;
            // è¨­ç½®æ–°çš„äº‹ä»¶ç›£è½å™¨
            routePhotoFromGallery.onchange = function() {
                handlePhotoChange(this);
            };
            console.log('å·²ç‚º routePhotoFromGallery è¨­ç½®äº‹ä»¶ç›£è½å™¨');
        }
    }
    
    function setupRouteNameExample() {
        // ç²å–ç•¶å‰æˆ¿é–“çš„è·¯ç·šæ•¸é‡ï¼Œè¨ˆç®—ä¸‹ä¸€å€‹è·¯ç·šç·¨è™Ÿ
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                const routeCount = data.routes ? data.routes.length : 0;
                const nextRouteNumber = routeCount + 1;
                const routeNameInput = document.getElementById('routeName');
                if (routeNameInput) {
                    routeNameInput.value = `è·¯ç·š${nextRouteNumber}`;
                    routeNameInput.select(); // è‡ªå‹•é¸å–ï¼Œæ–¹ä¾¿ç›´æ¥ä¿®æ”¹
                }
            })
            .catch(error => {
                console.error('ç²å–è·¯ç·šæ•¸é‡å¤±æ•—:', error);
                // å¦‚æœç²å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼
                const routeNameInput = document.getElementById('routeName');
                if (routeNameInput) {
                    routeNameInput.value = 'è·¯ç·š1';
                    routeNameInput.select();
                }
            });
    }

    function closeAddRouteModal() {
        document.getElementById('addRouteModal').style.display = 'none';
        document.getElementById('addRouteForm').reset();
    }

    function showEditRoomModal() {
        // è¡¨å–®å·²é€šé loadLeaderboard å¡«å……ï¼Œç›´æ¥é¡¯ç¤º
        document.getElementById('editRoomModal').style.display = 'block';
    }

    function closeEditRoomModal() {
        document.getElementById('editRoomModal').style.display = 'none';
    }

    // ç·¨è¼¯æˆ¿é–“è¡¨å–®æäº¤
    document.getElementById('editRoomForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name')
            // standard_line_score æœƒè‡ªå‹•è¨ˆç®—ï¼Œä¸éœ€è¦ç™¼é€
        };

        fetch(`/api/rooms/${ROOM_ID}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditRoomModal();
                refreshLeaderboard(true);
                showToast('æˆ¿é–“æ›´æ–°æˆåŠŸï¼', 'success');
                // åŒæ­¥æ›´æ–°æ’è¡Œæ¦œæ¨™é¡Œä¸­çš„æˆ¿é–“åç¨±
                if (data.name) {
                    const roomTitleInline = document.getElementById('roomTitleInline');
                    if (roomTitleInline) {
                        roomTitleInline.textContent = ' ' + data.name;
                    }
                }
                
                // åŒæ­¥æ›´æ–°å°èˆªæ¬„ä¸­çš„æˆ¿é–“è³‡è¨Š
                if (data.standard_line_score !== undefined) {
                    const navbarStandardLineScore = document.getElementById('navbarStandardLineScore');
                    if (navbarStandardLineScore) {
                        navbarStandardLineScore.textContent = data.standard_line_score;
                    }
                }
            } else {
                showToast('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data), 'error');
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æˆ¿é–“å¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            showToast('æ›´æ–°æˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
        });
    });

    // é—œé–‰å½ˆçª—ï¼ˆé»æ“Šå¤–éƒ¨ï¼‰
    window.onclick = function(event) {
        const addMemberModal = document.getElementById('addMemberModal');
        const addRouteModal = document.getElementById('addRouteModal');
        const editRouteModal = document.getElementById('editRouteModal');
        const editRoomModal = document.getElementById('editRoomModal');
        const editMemberModal = document.getElementById('editMemberModal');
        const completedRoutesModal = document.getElementById('completedRoutesModal');
        const photoModal = document.getElementById('photoModal');
        
        if (event.target === addMemberModal) {
            closeAddMemberModal();
        }
        if (event.target === addRouteModal) {
            closeAddRouteModal();
        }
        if (event.target === editRouteModal) {
            closeEditRouteModal();
        }
        if (event.target === editRoomModal) {
            closeEditRoomModal();
        }
        if (event.target === editMemberModal) {
            closeEditMemberModal();
        }
        if (event.target === completedRoutesModal) {
            closeCompletedRoutesModal();
        }
    }

    // ç·¨è¼¯è·¯ç·šè¡¨å–®æäº¤
    document.getElementById('editRouteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹
        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) {
            showToast('è«‹å…ˆç™»éŒ„æˆ–åˆ·æ–°é é¢å¾Œé‡è©¦', 'error');
            return;
        }
        
        const routeId = document.getElementById('editRouteId').value;
        const formData = new FormData();
        const memberCompletions = {};
        
        // æ”¶é›†æˆå“¡å®Œæˆç‹€æ…‹
        const checkboxes = document.querySelectorAll('#editMemberCompletions input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            memberCompletions[checkbox.value] = checkbox.checked;
        });

        // ç²å–è·¯ç·šåç¨±
        let routeName = document.getElementById('editRouteName').value.trim();
        
        // å¦‚æœç”¨æˆ¶æ²’æœ‰ä¿®æ”¹åç¨±ï¼Œä½¿ç”¨åŸå§‹å®Œæ•´åç¨±ï¼ˆé¿å…è‡ªå‹•æ·»åŠ å‰ç¶´å°è‡´é‡è¤‡ï¼‰
        // currentEditingRouteName ä¿å­˜çš„æ˜¯åŸå§‹å®Œæ•´åç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        // è¨ˆç®—ç·¨è¼¯æ¡†ä¸­æ‡‰è©²é¡¯ç¤ºçš„åŸå§‹åç¨±ï¼ˆä¸åŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        let originalDisplayName = '';
        if (currentEditingRouteName) {
            if (currentEditingRouteName.startsWith('ã€è·¯ç·šã€‘')) {
                originalDisplayName = currentEditingRouteName.substring(4); // ã€è·¯ç·šã€‘æ˜¯4å€‹å­—ç¬¦
            } else {
                originalDisplayName = currentEditingRouteName;
            }
        }
        
        // å¦‚æœç•¶å‰è¼¸å…¥çš„å€¼ç­‰æ–¼åŸå§‹é¡¯ç¤ºå€¼ï¼Œèªªæ˜ç”¨æˆ¶æ²’æœ‰ä¿®æ”¹
        if (originalDisplayName && routeName === originalDisplayName) {
            // ç”¨æˆ¶æ²’æœ‰ä¿®æ”¹åç¨±ï¼Œä½¿ç”¨åŸå§‹å®Œæ•´åç¨±
            routeName = currentEditingRouteName;
        } else {
            // ç”¨æˆ¶ä¿®æ”¹äº†åç¨±ï¼Œç¢ºä¿æœ‰ã€è·¯ç·šã€‘å‰ç¶´
            if (routeName && !routeName.startsWith('ã€è·¯ç·šã€‘')) {
                routeName = 'ã€è·¯ç·šã€‘' + routeName;
            }
        }

        // æ§‹å»º FormDataï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šå‚³ï¼‰
        formData.append('name', routeName);
        formData.append('grade', document.getElementById('editRouteGrade').value || '');
        // ç²å–ç…§ç‰‡æ–‡ä»¶ï¼ˆå„ªå…ˆä½¿ç”¨æ‹ç…§è¼¸å…¥æ¡†ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨åœ–åº«é¸æ“‡è¼¸å…¥æ¡†ï¼‰
        const editRoutePhotoInput = document.getElementById('editRoutePhoto');
        const editRoutePhotoFromGallery = document.getElementById('editRoutePhotoFromGallery');
        let photoFile = null;
        if (editRoutePhotoInput && editRoutePhotoInput.files && editRoutePhotoInput.files[0]) {
            photoFile = editRoutePhotoInput.files[0];
        } else if (editRoutePhotoFromGallery && editRoutePhotoFromGallery.files && editRoutePhotoFromGallery.files[0]) {
            photoFile = editRoutePhotoFromGallery.files[0];
        }
        if (photoFile) {
            formData.append('photo', photoFile);
        }
        formData.append('member_completions', JSON.stringify(memberCompletions));
        // æ·»åŠ  CSRF token åˆ° FormData
        formData.append('csrfmiddlewaretoken', csrfToken);

        // åœ¨ç™¼é€è«‹æ±‚å‰ï¼Œå…ˆæª¢æŸ¥èªè­‰ç‹€æ…‹ï¼ˆå¯é¸ï¼Œä½†å¯ä»¥æå‰ç™¼ç¾å•é¡Œï¼‰
        fetch(`/api/routes/${routeId}/`, {
            method: 'PATCH',
            headers: {
                'X-CSRFToken': csrfToken
            },
            credentials: 'include',
            body: formData
            // æ³¨æ„ï¼šä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®ï¼ˆåŒ…å« boundaryï¼‰
        })
        .then(response => {
            // å¦‚æœè¿”å› 401 æˆ– 403ï¼Œèªªæ˜èªè­‰å¤±æ•—
            if (response.status === 401 || response.status === 403) {
                return response.json().then(err => {
                    // å¦‚æœæ˜¯èªè­‰éŒ¯èª¤ï¼Œæä¾›æ›´å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
                    if (err.detail && err.detail.includes('Authentication')) {
                        showToast('èªè­‰å¤±æ•—ï¼Œè«‹å…ˆç™»éŒ„æˆ–åˆ·æ–°é é¢å¾Œé‡è©¦', 'error');
                        // å¯é¸ï¼šé‡å®šå‘åˆ°é¦–é 
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    }
                    return Promise.reject(err);
                });
            }
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditRouteModal();
                // é‡æ–°è¼‰å…¥è·¯ç·šåˆ—è¡¨ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„ç…§ç‰‡
                loadRoutes();
                refreshLeaderboard(true);
                showToast('è·¯ç·šæ›´æ–°æˆåŠŸï¼', 'success');
            } else {
                showToast('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data), 'error');
            }
        })
        .catch(error => {
            console.error('æ›´æ–°è·¯ç·šå¤±æ•—:', error);
            // è™•ç†èªè­‰éŒ¯èª¤
            if (error.detail && typeof error.detail === 'string' && error.detail.includes('Authentication')) {
                showToast('èªè­‰å¤±æ•—ï¼Œè«‹å…ˆç™»éŒ„æˆ–åˆ·æ–°é é¢å¾Œé‡è©¦', 'error');
            } else {
                const errorMsg = error.detail || error.message || JSON.stringify(error);
                showToast('æ›´æ–°è·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg, 'error');
            }
        });
    });

    // æ–°å¢æˆå“¡è¡¨å–®æäº¤
    document.getElementById('addMemberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const submitButton = e.target.querySelector('button[type="submit"]');
        
        // é©—è­‰æˆ¿é–“ ID
        const roomId = parseInt(ROOM_ID);
        if (isNaN(roomId) || roomId <= 0) {
            showToast('éŒ¯èª¤ï¼šç„¡æ•ˆçš„æˆ¿é–“ IDã€‚è«‹åˆ·æ–°é é¢é‡è©¦ã€‚', 'error');
            return;
        }

        const data = {
            room: roomId,
            name: formData.get('name'),
            is_custom_calc: document.getElementById('isCustomCalc').checked
        };

        // ç«‹å³å…³é—­æ¨¡æ€æ¡†ï¼Œæä¾›å³æ—¶åé¦ˆ
        closeAddMemberModal();
        
        // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
        setButtonLoading(submitButton, true);

        // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ·»åŠ åˆ° UIï¼ˆä¸´æ—¶æ˜¾ç¤ºï¼‰
        const tempMember = {
            name: data.name,
            is_custom_calc: data.is_custom_calc,
            total_score: 0,
            completed_routes_count: 0
        };
        const tempId = addMemberToLeaderboardOptimistic(tempMember);

        fetch('/api/members/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            // ç§»é™¤ä¸´æ—¶æˆå‘˜
            removeTempMember(tempId);
            
            if (data.id) {
                // åˆ·æ–°æ’è¡Œæ¦œï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
                refreshLeaderboard(true); // åªæ›´æ–°æ’è¡Œæ¦œï¼Œä¸é‡æ–°åŠ è½½è·¯çº¿
                loadMembersForRouteForm();
                showToast('æˆå“¡å‰µå»ºæˆåŠŸï¼', 'success');
            } else {
                showToast('å‰µå»ºå¤±æ•—: ' + JSON.stringify(data), 'error');
            }
        })
        .catch(error => {
            console.error('å‰µå»ºæˆå“¡å¤±æ•—:', error);
            
            // ç§»é™¤ä¸´æ—¶æˆå‘˜
            removeTempMember(tempId);
            
            // å›æ»šï¼šåˆ·æ–°æ’è¡Œæ¦œ
            refreshLeaderboard(true);
            
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'å‰µå»ºæˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤';
            if (error.name && error.name.length > 0) {
                errorMsg = error.name[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors) {
                errorMsg = error.non_field_errors[0];
            }
            showToast(errorMsg, 'error');
        })
        .finally(() => {
            setButtonLoading(submitButton, false);
        });
    });

    // ç·¨è¼¯æˆå“¡è¡¨å–®æäº¤
    document.getElementById('editMemberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const submitButton = e.target.querySelector('button[type="submit"]');
        const memberId = document.getElementById('editMemberId').value;

        const data = {
            name: formData.get('name'),
            is_custom_calc: document.getElementById('editIsCustomCalc').checked
        };

        // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
        setButtonLoading(submitButton, true);

        fetch(`/api/members/${memberId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditMemberModal();
                refreshLeaderboard(true); // åªæ›´æ–°æ’è¡Œæ¦œ
                loadMembersForRouteForm();
                showToast('æˆå“¡æ›´æ–°æˆåŠŸï¼', 'success');
            } else {
                showToast('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data), 'error');
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æˆå“¡å¤±æ•—:', error);
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'æ›´æ–°æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤';
            if (error.name && error.name.length > 0) {
                errorMsg = error.name[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors) {
                errorMsg = error.non_field_errors[0];
            }
            showToast(errorMsg, 'error');
        })
        .finally(() => {
            setButtonLoading(submitButton, false);
        });
    });

    document.getElementById('addRouteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitButton = e.target.querySelector('button[type="submit"]');
        
        // é©—è­‰é›£åº¦ç­‰ç´šæ˜¯å¦å·²é¸æ“‡
        const gradeValue = document.getElementById('routeGrade').value;
        if (!gradeValue || gradeValue.trim() === '') {
            showToast('è«‹é¸æ“‡é›£åº¦ç­‰ç´š', 'warning');
            document.getElementById('routeGrade').focus();
            return;
        }
        
        const formData = new FormData();
        const memberCompletions = {};
        
        // æ”¶é›†æˆå“¡å®Œæˆç‹€æ…‹
        const checkboxes = document.querySelectorAll('#memberCompletions input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            memberCompletions[checkbox.value] = checkbox.checked;
        });

        // ç¢ºä¿è·¯ç·šåç¨±æœ‰ã€è·¯ç·šã€‘å‰ç¶´
        let routeName = document.getElementById('routeName').value;
        if (routeName && !routeName.startsWith('ã€è·¯ç·šã€‘')) {
            routeName = 'ã€è·¯ç·šã€‘' + routeName;
        }

        // æ§‹å»º FormDataï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šå‚³ï¼‰
        formData.append('name', routeName);
        formData.append('grade', gradeValue);
        
        // ç²å–ç…§ç‰‡æ–‡ä»¶ï¼ˆå„ªå…ˆä½¿ç”¨åœ–åº«é¸æ“‡è¼¸å…¥æ¡†ï¼‰
        const routePhotoFromGallery = document.getElementById('routePhotoFromGallery');
        const routePhotoInput = document.getElementById('routePhoto');
        let photoFile = null;
        // å„ªå…ˆä½¿ç”¨åœ–åº«é¸æ“‡è¼¸å…¥æ¡†
        if (routePhotoFromGallery && routePhotoFromGallery.files && routePhotoFromGallery.files[0]) {
            photoFile = routePhotoFromGallery.files[0];
        } else if (routePhotoInput && routePhotoInput.files && routePhotoInput.files[0]) {
            photoFile = routePhotoInput.files[0];
        }
        
        if (photoFile) {
            formData.append('photo', photoFile);
        }
        formData.append('member_completions', JSON.stringify(memberCompletions));
        // æ·»åŠ  CSRF token åˆ° FormData
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        // ç«‹å³å…³é—­æ¨¡æ€æ¡†ï¼Œæä¾›å³æ—¶åé¦ˆ
        closeAddRouteModal();
        
        // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
        setButtonLoading(submitButton, true);

        fetch(`/api/rooms/${ROOM_ID}/routes/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: formData
            // æ³¨æ„ï¼šä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®ï¼ˆåŒ…å« boundaryï¼‰
        })
        .then(response => {
            // æª¢æŸ¥éŸ¿æ‡‰ç‹€æ…‹
            if (!response.ok) {
                // å¦‚æœä¸æ˜¯ 2xx ç‹€æ…‹ï¼Œå˜—è©¦è§£æéŒ¯èª¤éŸ¿æ‡‰
                return response.json().then(err => {
                    console.error('å‰µå»ºè·¯ç·šå¤±æ•— - éŸ¿æ‡‰éŒ¯èª¤:', err);
                    return Promise.reject(err);
                }).catch(() => {
                    // å¦‚æœç„¡æ³•è§£æ JSONï¼Œè¿”å›ç‹€æ…‹æ–‡æœ¬
                    return Promise.reject({
                        detail: `å‰µå»ºå¤±æ•— (ç‹€æ…‹ç¢¼: ${response.status})`,
                        status: response.status,
                        statusText: response.statusText
                    });
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                // é‡æ–°è¼‰å…¥è·¯ç·šåˆ—è¡¨ä»¥é¡¯ç¤ºæ–°ä¸Šå‚³çš„ç…§ç‰‡
                loadRoutes();
                refreshLeaderboard(true); // åªæ›´æ–°æ’è¡Œæ¦œ
                showToast('è·¯ç·šå‰µå»ºæˆåŠŸï¼', 'success');
            } else {
                // å¦‚æœæ²’æœ‰ idï¼Œå¯èƒ½æ˜¯é©—è­‰éŒ¯èª¤
                console.error('å‰µå»ºè·¯ç·šå¤±æ•— - éŸ¿æ‡‰æ•¸æ“š:', data);
                let errorMsg = 'å‰µå»ºå¤±æ•—';
                if (data.grade && Array.isArray(data.grade) && data.grade.length > 0) {
                    errorMsg = 'é›£åº¦ç­‰ç´šéŒ¯èª¤: ' + data.grade[0];
                } else if (data.photo && Array.isArray(data.photo) && data.photo.length > 0) {
                    errorMsg = 'åœ–ç‰‡éŒ¯èª¤: ' + data.photo[0];
                } else if (data.name && Array.isArray(data.name) && data.name.length > 0) {
                    errorMsg = 'è·¯ç·šåç¨±éŒ¯èª¤: ' + data.name[0];
                } else if (data.member_completions && Array.isArray(data.member_completions) && data.member_completions.length > 0) {
                    errorMsg = 'æˆå“¡å®Œæˆç‹€æ…‹éŒ¯èª¤: ' + data.member_completions[0];
                } else if (data.detail) {
                    errorMsg = data.detail;
                } else if (data.non_field_errors && Array.isArray(data.non_field_errors) && data.non_field_errors.length > 0) {
                    errorMsg = data.non_field_errors[0];
                } else {
                    errorMsg = 'å‰µå»ºå¤±æ•—: ' + JSON.stringify(data);
                }
                showToast(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('å‰µå»ºè·¯ç·šå¤±æ•—:', error);
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'å‰µå»ºè·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤';
            
            // æª¢æŸ¥å„ç¨®å¯èƒ½çš„éŒ¯èª¤æ ¼å¼
            if (error.grade && Array.isArray(error.grade) && error.grade.length > 0) {
                errorMsg = 'é›£åº¦ç­‰ç´šéŒ¯èª¤: ' + error.grade[0];
            } else if (error.photo && Array.isArray(error.photo) && error.photo.length > 0) {
                // è™•ç†ç…§ç‰‡ç›¸é—œéŒ¯èª¤ï¼Œç‰¹åˆ¥æ˜¯ "The string did not match the expected pattern"
                const photoError = error.photo[0];
                if (typeof photoError === 'string' && photoError.includes('string') && photoError.includes('pattern')) {
                    errorMsg = 'ç…§ç‰‡æ ¼å¼éŒ¯èª¤ï¼Œè«‹å˜—è©¦é‡æ–°é¸æ“‡ç…§ç‰‡æˆ–å°‡ç…§ç‰‡è½‰æ›ç‚º JPEG/PNG æ ¼å¼';
                } else {
                    errorMsg = 'åœ–ç‰‡éŒ¯èª¤: ' + photoError;
                }
            } else if (error.name && Array.isArray(error.name) && error.name.length > 0) {
                errorMsg = 'è·¯ç·šåç¨±éŒ¯èª¤: ' + error.name[0];
            } else if (error.member_completions && Array.isArray(error.member_completions) && error.member_completions.length > 0) {
                errorMsg = 'æˆå“¡å®Œæˆç‹€æ…‹éŒ¯èª¤: ' + error.member_completions[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors && Array.isArray(error.non_field_errors) && error.non_field_errors.length > 0) {
                errorMsg = error.non_field_errors[0];
            } else {
                // å˜—è©¦å¾éŒ¯èª¤å°è±¡ä¸­æå–æ›´å¤šä¿¡æ¯
                const errorKeys = Object.keys(error);
                if (errorKeys.length > 0) {
                    const firstKey = errorKeys[0];
                    const firstValue = error[firstKey];
                    if (Array.isArray(firstValue) && firstValue.length > 0) {
                        errorMsg = `${firstKey}: ${firstValue[0]}`;
                    } else {
                        errorMsg = `éŒ¯èª¤: ${JSON.stringify(error)}`;
                    }
                }
            }
            
            showToast(errorMsg, 'error');
        })
        .finally(() => {
            setButtonLoading(submitButton, false);
        });
    });
</script>
{% endblock %}

