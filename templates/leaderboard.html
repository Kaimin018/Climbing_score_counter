{% extends 'base.html' %}
{% load static %}

{% block title %}æ’è¡Œæ¦œ - æ”€å²©è¨ˆåˆ†ç³»çµ±{% endblock %}

{% block content %}
<div class="leaderboard-layout">
    <!-- å·¦å´ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <div class="leaderboard-container">
            <div class="room-header" id="roomHeader">
                <div class="header-top">
                    <button class="btn btn-secondary btn-small" onclick="goHome()" style="margin-right: 10px;">
                        â† è¿”å›é¦–é 
                    </button>
                    <h2 id="roomName" style="flex: 1;">è¼‰å…¥ä¸­...</h2>
                    <a href="/rules/" class="btn btn-secondary btn-small" style="margin-left: 10px; text-decoration: none; display: inline-block;">
                        è¦å‰‡èªªæ˜
                    </a>
                    <button class="btn btn-secondary btn-small" onclick="showEditRoomModal()" style="margin-left: 10px;">
                        ç·¨è¼¯æˆ¿é–“
                    </button>
                </div>
                <div class="room-info">
                    <span>æˆ¿é–“ ID: <strong id="roomIdDisplay">-</strong></span>
                    <span style="margin-left: 20px;">æ¯ä¸€æ¢ç·šç¸½åˆ† (L): <strong id="standardLineScore">-</strong></span>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" onclick="showAddMemberModal()">æ–°å¢æˆå“¡</button>
                <button class="btn btn-primary" onclick="showAddRouteModal()">æ–°å¢è·¯ç·š</button>
                <button class="btn btn-secondary" onclick="refreshLeaderboard()">åˆ·æ–°æ’è¡Œæ¦œ</button>
            </div>

            <div class="routes-section" style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">è·¯ç·šåˆ—è¡¨</h3>
                <div id="routesList" class="routes-list">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´å›ºå®šæ’è¡Œæ¦œ -->
    <div class="leaderboard-sidebar">
        <div class="leaderboard-sidebar-header">
            <h3>æ’è¡Œæ¦œ</h3>
            <button class="btn btn-secondary btn-small" onclick="refreshLeaderboard()" title="åˆ·æ–°æ’è¡Œæ¦œ">
                ğŸ”„
            </button>
        </div>
        <div class="leaderboard-table-wrapper">
            <div class="leaderboard-table">
                <table>
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æˆå“¡</th>
                            <th>ç¸½åˆ†</th>
                            <th>å®Œæˆæ¢æ•¸</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr>
                            <td colspan="5" class="loading">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢æˆå“¡å½ˆçª— -->
<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å¢æˆå“¡</h3>
            <span class="close" onclick="closeAddMemberModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addMemberForm">
                <div class="form-group">
                    <label for="memberName">æˆå“¡åç¨±:</label>
                    <input type="text" id="memberName" name="name" required placeholder="è«‹è¼¸å…¥æˆå“¡åç¨±">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isCustomCalc" name="is_custom_calc">
                        æ˜¯å¦ç‚ºå®¢è£½åŒ–çµ„
                    </label>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        å‹¾é¸å¾Œï¼Œè©²æˆå“¡æ¯å®Œæˆä¸€æ¢è·¯ç·šå›ºå®šç²å¾— L åˆ†ï¼Œä¸æœƒè¢«å…¶ä»–æˆå“¡åˆ†æ”¤åˆ†æ•¸ã€‚é©åˆç¨‹åº¦è¼ƒä½çš„æœ‹å‹åŠ å…¥å°æˆ°ã€‚
                    </small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºæˆå“¡</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddMemberModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æˆå“¡å½ˆçª— -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯æˆå“¡</h3>
            <span class="close" onclick="closeEditMemberModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId" name="member_id">
                <div class="form-group">
                    <label for="editMemberName">æˆå“¡åç¨±:</label>
                    <input type="text" id="editMemberName" name="name" required placeholder="è«‹è¼¸å…¥æˆå“¡åç¨±">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsCustomCalc" name="is_custom_calc">
                        æ˜¯å¦ç‚ºå®¢è£½åŒ–çµ„
                    </label>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        å‹¾é¸å¾Œï¼Œè©²æˆå“¡æ¯å®Œæˆä¸€æ¢è·¯ç·šå›ºå®šç²å¾— L åˆ†ï¼Œä¸æœƒè¢«å…¶ä»–æˆå“¡åˆ†æ”¤åˆ†æ•¸ã€‚é©åˆç¨‹åº¦è¼ƒä½çš„æœ‹å‹åŠ å…¥å°æˆ°ã€‚
                    </small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteMemberFromEditModal()" style="margin-right: auto;">
                        åˆªé™¤æˆå“¡
                    </button>
                    <button type="submit" class="btn btn-primary">æ›´æ–°æˆå“¡</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditMemberModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æˆ¿é–“å½ˆçª— -->
<div id="editRoomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯æˆ¿é–“</h3>
            <span class="close" onclick="closeEditRoomModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editRoomForm">
                <input type="hidden" id="editRoomId" name="room_id">
                <div class="form-group">
                    <label for="editRoomName">æˆ¿é–“åç¨±:</label>
                    <input type="text" id="editRoomName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editRoomStandardLineScore">æ¯ä¸€æ¢ç·šç¸½åˆ† (L):</label>
                    <input type="number" id="editRoomStandardLineScore" name="standard_line_score" 
                           min="1" max="100" required disabled>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        æ¯ä¸€æ¢ç·šç¸½åˆ†æœƒè‡ªå‹•æ ¹æ“šä¸€èˆ¬çµ„æˆå“¡æ•¸è¨ˆç®—ï¼ˆæœ€å°å…¬å€æ•¸ï¼‰ï¼Œç„¡æ³•æ‰‹å‹•ä¿®æ”¹
                    </small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">æ›´æ–°æˆ¿é–“</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRoomModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯è·¯ç·šå½ˆçª— -->
<div id="editRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç·¨è¼¯è·¯ç·š</h3>
            <span class="close" onclick="closeEditRouteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editRouteForm">
                <input type="hidden" id="editRouteId" name="route_id">
                <div class="form-group">
                    <label for="editRouteName">è·¯ç·šåç¨±:</label>
                    <input type="text" id="editRouteName" name="name" required placeholder="ä¾‹å¦‚ï¼š123456">
                    <small style="display: block; color: #666; margin-top: 5px;">
                        è¼¸å…¥çš„åç¨±æœƒè‡ªå‹•åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´ï¼ˆç·¨è¼¯æ™‚æœƒè‡ªå‹•ç§»é™¤å‰ç¶´ä»¥ä¾¿ä¿®æ”¹ï¼‰
                    </small>
                </div>
                <div class="form-group">
                    <label for="editRouteGrade">é›£åº¦ç­‰ç´š (Grade):</label>
                    <select id="editRouteGrade" name="grade">
                        <option value="">è«‹é¸æ“‡é›£åº¦</option>
                        <option value="V1">V1</option>
                        <option value="V2">V2</option>
                        <option value="V3">V3</option>
                        <option value="V4">V4</option>
                        <option value="V5">V5</option>
                        <option value="V6">V6</option>
                        <option value="V7">V7</option>
                        <option value="V8+">V8+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editRoutePhoto">ç…§ç‰‡:</label>
                    <input type="file" id="editRoutePhoto" name="photo" accept="image/*">
                    <div id="editRoutePhotoPreview" style="margin-top: 10px;"></div>
                    <small style="display: block; color: #666; margin-top: 5px;">
                        æ”¯æ´æ‰‹æ©Ÿæ‹ç…§ä¸Šå‚³ï¼ˆé»æ“Šå¾Œå¯ç›´æ¥ä½¿ç”¨ç›¸æ©Ÿæ‹æ”ï¼‰ã€‚å¦‚éœ€æ›´æ›ç…§ç‰‡ï¼Œè«‹é¸æ“‡æ–°ç…§ç‰‡ã€‚
                    </small>
                </div>
                <div class="form-group">
                    <label>æˆå“¡å®Œæˆç‹€æ…‹:</label>
                    <div id="editMemberCompletions" class="member-completions">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="deleteRouteFromEditModal()" style="margin-right: auto;">
                        åˆªé™¤è·¯ç·š
                    </button>
                    <button type="submit" class="btn btn-primary">æ›´æ–°è·¯ç·š</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRouteModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹å®Œæˆè·¯ç·šå½ˆçª— -->
<div id="completedRoutesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="completedRoutesModalTitle">å®Œæˆçš„è·¯ç·š</h3>
            <span class="close" onclick="closeCompletedRoutesModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="completedRoutesList" class="completed-routes-list">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
</div>

<!-- åœ–ç‰‡å¤§åœ–æŸ¥çœ‹å½ˆçª— -->
<div id="photoModal" class="modal">
    <div class="modal-content photo-modal-content">
        <div class="modal-header">
            <h3 id="photoModalTitle">è·¯ç·šåœ–ç‰‡</h3>
            <span class="close" onclick="closePhotoModal()">&times;</span>
        </div>
        <div class="modal-body photo-modal-body">
            <img id="photoModalImage" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;">
        </div>
    </div>
</div>

<!-- æ–°å¢è·¯ç·šå½ˆçª— -->
<div id="addRouteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°å¢è·¯ç·š</h3>
            <span class="close" onclick="closeAddRouteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addRouteForm">
                <div class="form-group">
                    <label for="routeName">è·¯ç·šåç¨±:</label>
                    <input type="text" id="routeName" name="name" required placeholder="è·¯ç·š1">
                    <small style="display: block; color: #666; margin-top: 5px;">
                        è¼¸å…¥çš„åç¨±æœƒè‡ªå‹•åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´
                    </small>
                </div>
                <div class="form-group">
                    <label for="routeGrade">é›£åº¦ç­‰ç´š (Grade): <span style="color: red;">*</span></label>
                    <select id="routeGrade" name="grade" required>
                        <option value="">è«‹é¸æ“‡é›£åº¦</option>
                        <option value="V1">V1</option>
                        <option value="V2">V2</option>
                        <option value="V3">V3</option>
                        <option value="V4">V4</option>
                        <option value="V5">V5</option>
                        <option value="V6">V6</option>
                        <option value="V7">V7</option>
                        <option value="V8+">V8+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="routePhoto">ç…§ç‰‡:</label>
                    <input type="file" id="routePhoto" name="photo" accept="image/*">
                    <small style="display: block; color: #666; margin-top: 5px;">
                        æ”¯æ´æ‰‹æ©Ÿæ‹ç…§ä¸Šå‚³ï¼ˆæ‰‹æ©Ÿä¸Šé»æ“Šå¾Œå¯ç›´æ¥ä½¿ç”¨ç›¸æ©Ÿæ‹æ”ï¼‰
                    </small>
                </div>
                <div class="form-group">
                    <label>æˆå“¡å®Œæˆç‹€æ…‹:</label>
                    <div id="memberCompletions" class="member-completions">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºè·¯ç·š</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddRouteModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 120px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .dropdown-content a {
        color: #333;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        cursor: pointer;
    }
    
    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }
    
    .dropdown-content a:first-child {
        border-bottom: 1px solid #ddd;
    }
</style>
<script>
    let ROOM_ID = {{ room_id|default:1 }};
    
    function goHome() {
        window.location.href = '/';
    }
    
    function toggleDropdown(event, dropdownId) {
        event.stopPropagation();
        // é—œé–‰æ‰€æœ‰å…¶ä»–ä¸‹æ‹‰èœå–®
        document.querySelectorAll('.dropdown-content').forEach(function(dropdown) {
            if (dropdown.id !== dropdownId) {
                dropdown.style.display = 'none';
            }
        });
        // åˆ‡æ›ç•¶å‰ä¸‹æ‹‰èœå–®
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    function closeDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }
    
    // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚é—œé–‰æ‰€æœ‰ä¸‹æ‹‰èœå–®
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content').forEach(function(dropdown) {
                dropdown.style.display = 'none';
            });
        }
    });
    
    // é é¢è¼‰å…¥æ™‚ç²å–æ’è¡Œæ¦œå’Œè·¯ç·šåˆ—è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        loadLeaderboard();
        loadMembersForRouteForm();
        loadRoutes();
    });

    function loadLeaderboard() {
        fetch(`/api/rooms/${ROOM_ID}/leaderboard/`)
            .then(response => response.json())
            .then(data => {
                displayLeaderboard(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
                document.getElementById('leaderboardBody').innerHTML = 
                    '<tr><td colspan="5" class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</td></tr>';
            });
    }

    function displayLeaderboard(data) {
        const roomInfo = data.room_info;
        const leaderboard = data.leaderboard;

        // æ›´æ–°æˆ¿é–“è³‡è¨Šä¸¦è¨­ç½®æ­£ç¢ºçš„æˆ¿é–“ ID
        ROOM_ID = roomInfo.id; // å¾ API ç²å–å¯¦éš›çš„æˆ¿é–“ ID
        document.getElementById('roomName').textContent = roomInfo.name;
        document.getElementById('roomIdDisplay').textContent = roomInfo.id;
        document.getElementById('standardLineScore').textContent = roomInfo.standard_line_score;
        
        // æ›´æ–°ç·¨è¼¯æˆ¿é–“è¡¨å–®çš„é è¨­å€¼
        document.getElementById('editRoomId').value = roomInfo.id;
        document.getElementById('editRoomName').value = roomInfo.name;
        document.getElementById('editRoomStandardLineScore').value = roomInfo.standard_line_score;

        // æ›´æ–°æ’è¡Œæ¦œ
        const tbody = document.getElementById('leaderboardBody');
        if (leaderboard.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty">å°šç„¡æˆå“¡æ•¸æ“š</td></tr>';
            return;
        }

        tbody.innerHTML = leaderboard.map((member, index) => {
            const rank = index + 1;
            const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
            const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
            return `
                <tr class="${rankClass}">
                    <td>${rankIcon ? rankIcon + ' ' : ''}${rank}</td>
                    <td><strong>${member.name}</strong>${member.is_custom_calc ? ' <span style="color: #95a5a6; font-size: 0.75rem; font-weight: normal;">(å®¢)</span>' : ''}</td>
                    <td class="score">${parseFloat(member.total_score).toFixed(2)}</td>
                    <td>
                        <a href="#" class="completed-routes-link" onclick="showCompletedRoutes(${member.id}, '${member.name.replace(/'/g, "\\'")}'); return false;" title="é»æ“ŠæŸ¥çœ‹å®Œæˆçš„è·¯ç·š">
                            ${member.completed_routes_count}
                        </a>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="editMember(${member.id}, '${member.name}', ${member.is_custom_calc})" title="ç·¨è¼¯æˆå“¡">
                            ç·¨è¼¯
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function refreshLeaderboard() {
        // å…ˆé‡æ–°è¼‰å…¥è·¯ç·šåˆ—è¡¨ï¼Œç¢ºä¿æ•¸æ“šåŒæ­¥
        loadRoutes();
        // ç„¶å¾Œè¼‰å…¥æ’è¡Œæ¦œ
        loadLeaderboard();
    }

    function showCompletedRoutes(memberId, memberName) {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('completedRoutesModalTitle').textContent = `${memberName} å®Œæˆçš„è·¯ç·š`;
        document.getElementById('completedRoutesList').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
        document.getElementById('completedRoutesModal').style.display = 'block';
        
        // ç²å–æˆå“¡å®Œæˆçš„è·¯ç·š
        fetch(`/api/members/${memberId}/completed-routes/`)
            .then(response => response.json())
            .then(data => {
                displayCompletedRoutes(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥å®Œæˆè·¯ç·šå¤±æ•—:', error);
                document.getElementById('completedRoutesList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦</div>';
            });
    }

    function displayCompletedRoutes(data) {
        const container = document.getElementById('completedRoutesList');
        const routes = data.completed_routes || [];
        
        if (routes.length === 0) {
            container.innerHTML = '<div class="empty">è©²æˆå“¡å°šæœªå®Œæˆä»»ä½•è·¯ç·š</div>';
            return;
        }
        
        container.innerHTML = routes.map(route => {
            const routeName = route.name || 'æœªå‘½åè·¯ç·š';
            const grade = route.grade || '-';
            const photoUrl = route.photo_url || '';
            
            // çµ±è¨ˆå®Œæˆäººæ•¸
            const scores = route.scores || [];
            const completedCount = scores.filter(s => s.is_completed).length;
            const totalCount = scores.length;
            
            return `
                <div class="completed-route-item">
                    <div class="completed-route-header">
                        <div class="completed-route-info">
                            <strong>${routeName}</strong>
                            <span class="route-grade-badge">${grade}</span>
                        </div>
                        <div class="completed-route-stats">
                            å®Œæˆæ¢æ•¸: ${completedCount}/${totalCount} äºº
                        </div>
                    </div>
                    ${photoUrl ? `<div class="completed-route-photo"><img src="${photoUrl}" alt="${routeName}" style="max-width: 100%; border-radius: 4px; margin-top: 10px;"></div>` : ''}
                </div>
            `;
        }).join('');
    }

    function closeCompletedRoutesModal() {
        document.getElementById('completedRoutesModal').style.display = 'none';
    }

    function showPhotoModal(photoUrl, routeName) {
        document.getElementById('photoModalTitle').textContent = routeName || 'è·¯ç·šåœ–ç‰‡';
        document.getElementById('photoModalImage').src = photoUrl;
        document.getElementById('photoModalImage').alt = routeName || 'è·¯ç·šåœ–ç‰‡';
        document.getElementById('photoModal').style.display = 'block';
    }

    function closePhotoModal() {
        document.getElementById('photoModal').style.display = 'none';
    }

    function loadRoutes() {
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                displayRoutes(data.routes || []);
            })
            .catch(error => {
                console.error('è¼‰å…¥è·¯ç·šåˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('routesList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</div>';
            });
    }

    function displayRoutes(routes) {
        const container = document.getElementById('routesList');
        
        if (!routes || routes.length === 0) {
            container.innerHTML = '<div class="empty">å°šç„¡è·¯ç·šï¼Œè«‹å‰µå»ºè·¯ç·š</div>';
            return;
        }

        container.innerHTML = routes.map(route => {
            // çµ±è¨ˆå®Œæˆäººæ•¸
            const completedCount = route.scores ? route.scores.filter(s => s.is_completed).length : 0;
            const totalCount = route.scores ? route.scores.length : 0;
            
            // åœ¨è·¯ç·šåç¨±å‰åŠ ä¸Šã€è·¯ç·šã€‘å‰ç¶´
            const routeDisplayName = route.name.startsWith('ã€è·¯ç·šã€‘') 
                ? route.name 
                : 'ã€è·¯ç·šã€‘' + route.name;
            
            // å¦‚æœæœ‰åœ–ç‰‡ï¼Œé¡¯ç¤ºç¸®åœ–
            const photoUrl = route.photo_url || '';
            const photoThumbnail = photoUrl ? `
                <img src="${photoUrl}" alt="${routeDisplayName}" class="route-photo-thumbnail" 
                     onclick="showPhotoModal('${photoUrl}', '${routeDisplayName}')" 
                     title="é»æ“ŠæŸ¥çœ‹å¤§åœ–">
            ` : '';
            
            return `
                <div class="route-item">
                    <div class="route-info">
                        <div class="route-name-grade">
                            <strong>${routeDisplayName}</strong>
                            ${route.grade ? `<span class="route-grade">${route.grade}</span>` : ''}
                            ${photoThumbnail}
                        </div>
                        <div class="route-stats">
                            å®Œæˆæ¢æ•¸: ${completedCount}/${totalCount} äºº
                        </div>
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-primary btn-small" onclick="editRoute(${route.id})">
                            ç·¨è¼¯
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editRoute(routeId) {
        // ç²å–è·¯ç·šè©³æƒ…
        fetch(`/api/routes/${routeId}/`)
            .then(response => response.json())
            .then(route => {
                showEditRouteModal(route);
            })
            .catch(error => {
                console.error('è¼‰å…¥è·¯ç·šè©³æƒ…å¤±æ•—:', error);
                alert('è¼‰å…¥è·¯ç·šè©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤');
            });
    }

    function showEditRouteModal(route) {
        // ä¿å­˜åŸå§‹è·¯ç·šåç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        const originalRouteName = route.name || '';
        
        // å¡«å……è¡¨å–®ï¼ˆç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ä»¥ä¾¿ç·¨è¼¯ï¼‰
        let routeNameForEdit = originalRouteName;
        // ç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ï¼ˆ4å€‹å­—ç¬¦ï¼šã€ã€è·¯ã€ç·šã€ã€‘ï¼‰
        if (routeNameForEdit.startsWith('ã€è·¯ç·šã€‘')) {
            routeNameForEdit = routeNameForEdit.substring(4); // ç§»é™¤ã€è·¯ç·šã€‘å‰ç¶´ï¼ˆ4å€‹å­—ç¬¦ï¼‰
        }
        // å¦‚æœç§»é™¤å¾Œçš„åç¨±ä¸åŒ…å«"è·¯ç·š"ä½†åªæ˜¯ä¸€å€‹æ•¸å­—ï¼Œæ·»åŠ "è·¯ç·š"å‰ç¶´
        // ä¾‹å¦‚ï¼š"ç·š3" -> "è·¯ç·š3"ï¼Œ"3" -> "è·¯ç·š3"
        if (routeNameForEdit && !routeNameForEdit.includes('è·¯ç·š') && /^[ç·šè·¯\d]+$/.test(routeNameForEdit)) {
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„"ç·š"æˆ–"è·¯"å­—ç¬¦ï¼Œç„¶å¾Œæ·»åŠ "è·¯ç·š"
            routeNameForEdit = routeNameForEdit.replace(/^[ç·šè·¯]*/, '');
            if (routeNameForEdit && /^\d+$/.test(routeNameForEdit)) {
                routeNameForEdit = 'è·¯ç·š' + routeNameForEdit;
            } else if (!routeNameForEdit || routeNameForEdit === '') {
                // å¦‚æœå®Œå…¨ç§»é™¤å¾Œç‚ºç©ºï¼Œä¿æŒåŸæ¨£æˆ–æ·»åŠ é è¨­å€¼
                routeNameForEdit = 'è·¯ç·š1';
            }
        }
        
        currentEditingRouteId = route.id;
        // ä¿å­˜åŸå§‹åç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰å’Œç·¨è¼¯ç”¨çš„åç¨±ï¼ˆä¸åŒ…å«å‰ç¶´ï¼‰
        currentEditingRouteName = originalRouteName; // ä¿å­˜åŸå§‹å®Œæ•´åç¨±
        document.getElementById('editRouteId').value = route.id;
        document.getElementById('editRouteName').value = routeNameForEdit;
        document.getElementById('editRouteGrade').value = route.grade || '';
        
        // é¡¯ç¤ºç¾æœ‰ç…§ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
        const photoPreview = document.getElementById('editRoutePhotoPreview');
        if (route.photo_url) {
            photoPreview.innerHTML = `
                <div style="margin-top: 10px;">
                    <p style="font-size: 14px; color: #666; margin-bottom: 5px;">ç›®å‰ç…§ç‰‡:</p>
                    <img src="${route.photo_url}" alt="è·¯ç·šç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">
                </div>
            `;
        } else {
            photoPreview.innerHTML = '';
        }
        
        // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥ï¼ˆå› ç‚ºæ–‡ä»¶è¼¸å…¥ç„¡æ³•è¨­ç½®å€¼ï¼‰
        const editPhotoInput = document.getElementById('editRoutePhoto');
        if (editPhotoInput) {
            editPhotoInput.value = '';
            // åªåœ¨ç§»å‹•è¨­å‚™ä¸Šæ·»åŠ  capture å±¬æ€§
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                editPhotoInput.setAttribute('capture', 'environment');
            } else {
                editPhotoInput.removeAttribute('capture');
            }
        }
        
        // å¡«å……æˆå“¡å®Œæˆç‹€æ…‹
        const container = document.getElementById('editMemberCompletions');
        loadMembersForEditRouteForm(container, route.scores || []);
        
        // é¡¯ç¤ºå½ˆçª—
        document.getElementById('editRouteModal').style.display = 'block';
    }

    let currentEditingRouteId = null;
    let currentEditingRouteName = null;

    function closeEditRouteModal() {
        document.getElementById('editRouteModal').style.display = 'none';
        document.getElementById('editRouteForm').reset();
        currentEditingRouteId = null;
        currentEditingRouteName = null;
    }

    function deleteRouteFromEditModal() {
        const routeId = document.getElementById('editRouteId').value;
        const routeName = document.getElementById('editRouteName').value || 'æ­¤è·¯ç·š';
        
        if (!routeId) {
            alert('éŒ¯èª¤ï¼šç„¡æ³•ç²å–è·¯ç·šè³‡è¨Š');
            return;
        }
        
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤è·¯ç·š "${routeName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²è·¯ç·šçš„æ‰€æœ‰æˆç¸¾è¨˜éŒ„ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }
        
        // é—œé–‰ç·¨è¼¯å½ˆçª—
        closeEditRouteModal();
        
        // åŸ·è¡Œåˆªé™¤è·¯ç·šæ“ä½œ
        fetch(`/api/routes/${routeId}/`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.status === 204 || response.ok) {
                alert('è·¯ç·šå·²åˆªé™¤');
                refreshLeaderboard();
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤è·¯ç·šå¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('åˆªé™¤è·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    }

    function loadMembersForEditRouteForm(container, scores) {
        // å°‡åˆ†æ•¸è¨˜éŒ„è½‰æ›ç‚ºå­—å…¸ï¼Œä¾¿æ–¼æŸ¥æ‰¾
        const scoreMap = {};
        scores.forEach(score => {
            scoreMap[score.member_id] = score.is_completed;
        });

        // ç²å–æˆå“¡åˆ—è¡¨ä¸¦é¡¯ç¤º
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                container.innerHTML = (data.members || []).map(member => {
                    const isCompleted = scoreMap[member.id] || false;
                    return `
                        <label class="member-checkbox">
                            <input type="checkbox" name="member_${member.id}" value="${member.id}" ${isCompleted ? 'checked' : ''}>
                            ${member.name} ${member.is_custom_calc ? '(Y)' : '(N)'}
                        </label>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—:', error);
            });
    }
    

    function loadMembersForRouteForm() {
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                displayMembersForForm(data.members);
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—:', error);
            });
    }

    function displayMembersForForm(members) {
        const container = document.getElementById('memberCompletions');
        container.innerHTML = members.map(member => {
            return `
                <label class="member-checkbox">
                    <input type="checkbox" name="member_${member.id}" value="${member.id}">
                    ${member.name} ${member.is_custom_calc ? '(Y)' : '(N)'}
                </label>
            `;
        }).join('');
    }

    function showAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'block';
        // è‡ªå‹•èšç„¦åˆ°æˆå“¡åç¨±è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ç›´æ¥è¼¸å…¥
        setTimeout(function() {
            const memberNameInput = document.getElementById('memberName');
            if (memberNameInput) {
                memberNameInput.focus();
            }
        }, 100); // ç¨å»¶é²ç¢ºä¿å½ˆçª—å·²å®Œå…¨é¡¯ç¤º
    }

    function closeAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'none';
        document.getElementById('addMemberForm').reset();
    }

    let currentEditingMemberId = null;
    let currentEditingMemberName = null;

    function editMember(memberId, memberName, isCustomCalc) {
        currentEditingMemberId = memberId;
        currentEditingMemberName = memberName;
        document.getElementById('editMemberId').value = memberId;
        document.getElementById('editMemberName').value = memberName;
        document.getElementById('editIsCustomCalc').checked = isCustomCalc;
        document.getElementById('editMemberModal').style.display = 'block';
    }

    function closeEditMemberModal() {
        document.getElementById('editMemberModal').style.display = 'none';
        document.getElementById('editMemberForm').reset();
        currentEditingMemberId = null;
        currentEditingMemberName = null;
    }

    function deleteMemberFromEditModal() {
        if (!currentEditingMemberId || !currentEditingMemberName) {
            alert('éŒ¯èª¤ï¼šç„¡æ³•ç²å–æˆå“¡è³‡è¨Š');
            return;
        }
        
        // é—œé–‰ç·¨è¼¯å½ˆçª—
        closeEditMemberModal();
        
        // åŸ·è¡Œåˆªé™¤æ“ä½œ
        deleteMember(currentEditingMemberId, currentEditingMemberName);
    }

    function deleteMember(memberId, memberName) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤æˆå“¡ "${memberName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²æˆå“¡çš„æ‰€æœ‰æˆç¸¾è¨˜éŒ„ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }

        fetch(`/api/members/${memberId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.status === 204 || response.ok) {
                alert('æˆå“¡å·²åˆªé™¤');
                refreshLeaderboard();
                loadMembersForRouteForm(); // åˆ·æ–°æˆå“¡åˆ—è¡¨ä¾›è·¯ç·šè¡¨å–®ä½¿ç”¨
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤æˆå“¡å¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('åˆªé™¤æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    }

    function showAddRouteModal() {
        document.getElementById('addRouteModal').style.display = 'block';
        // è¨­ç½®è·¯ç·šåç¨±é è¨­å€¼ï¼ˆè·¯ç·š1ã€è·¯ç·š2ç­‰ï¼‰
        setTimeout(function() {
            setupRouteNameExample();
        }, 100);
        // åªåœ¨ç§»å‹•è¨­å‚™ä¸Šæ·»åŠ  capture å±¬æ€§
        const routePhotoInput = document.getElementById('routePhoto');
        if (routePhotoInput && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            routePhotoInput.setAttribute('capture', 'environment');
        } else if (routePhotoInput) {
            routePhotoInput.removeAttribute('capture');
        }
    }
    
    function setupRouteNameExample() {
        // ç²å–ç•¶å‰æˆ¿é–“çš„è·¯ç·šæ•¸é‡ï¼Œè¨ˆç®—ä¸‹ä¸€å€‹è·¯ç·šç·¨è™Ÿ
        fetch(`/api/rooms/${ROOM_ID}/`)
            .then(response => response.json())
            .then(data => {
                const routeCount = data.routes ? data.routes.length : 0;
                const nextRouteNumber = routeCount + 1;
                const routeNameInput = document.getElementById('routeName');
                if (routeNameInput) {
                    routeNameInput.value = `è·¯ç·š${nextRouteNumber}`;
                    routeNameInput.select(); // è‡ªå‹•é¸å–ï¼Œæ–¹ä¾¿ç›´æ¥ä¿®æ”¹
                }
            })
            .catch(error => {
                console.error('ç²å–è·¯ç·šæ•¸é‡å¤±æ•—:', error);
                // å¦‚æœç²å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼
                const routeNameInput = document.getElementById('routeName');
                if (routeNameInput) {
                    routeNameInput.value = 'è·¯ç·š1';
                    routeNameInput.select();
                }
            });
    }

    function closeAddRouteModal() {
        document.getElementById('addRouteModal').style.display = 'none';
        document.getElementById('addRouteForm').reset();
    }

    function showEditRoomModal() {
        // è¡¨å–®å·²é€šé loadLeaderboard å¡«å……ï¼Œç›´æ¥é¡¯ç¤º
        document.getElementById('editRoomModal').style.display = 'block';
    }

    function closeEditRoomModal() {
        document.getElementById('editRoomModal').style.display = 'none';
    }

    // ç·¨è¼¯æˆ¿é–“è¡¨å–®æäº¤
    document.getElementById('editRoomForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name')
            // standard_line_score æœƒè‡ªå‹•è¨ˆç®—ï¼Œä¸éœ€è¦ç™¼é€
        };

        fetch(`/api/rooms/${ROOM_ID}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditRoomModal();
                refreshLeaderboard();
                alert('æˆ¿é–“æ›´æ–°æˆåŠŸï¼');
            } else {
                alert('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æˆ¿é–“å¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('æ›´æ–°æˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    });

    // é—œé–‰å½ˆçª—ï¼ˆé»æ“Šå¤–éƒ¨ï¼‰
    window.onclick = function(event) {
        const addMemberModal = document.getElementById('addMemberModal');
        const addRouteModal = document.getElementById('addRouteModal');
        const editRouteModal = document.getElementById('editRouteModal');
        const editRoomModal = document.getElementById('editRoomModal');
        const editMemberModal = document.getElementById('editMemberModal');
        const completedRoutesModal = document.getElementById('completedRoutesModal');
        const photoModal = document.getElementById('photoModal');
        
        if (event.target === addMemberModal) {
            closeAddMemberModal();
        }
        if (event.target === addRouteModal) {
            closeAddRouteModal();
        }
        if (event.target === editRouteModal) {
            closeEditRouteModal();
        }
        if (event.target === editRoomModal) {
            closeEditRoomModal();
        }
        if (event.target === editMemberModal) {
            closeEditMemberModal();
        }
        if (event.target === completedRoutesModal) {
            closeCompletedRoutesModal();
        }
    }

    // ç·¨è¼¯è·¯ç·šè¡¨å–®æäº¤
    document.getElementById('editRouteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const routeId = document.getElementById('editRouteId').value;
        const formData = new FormData();
        const memberCompletions = {};
        
        // æ”¶é›†æˆå“¡å®Œæˆç‹€æ…‹
        const checkboxes = document.querySelectorAll('#editMemberCompletions input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            memberCompletions[checkbox.value] = checkbox.checked;
        });

        // ç²å–è·¯ç·šåç¨±
        let routeName = document.getElementById('editRouteName').value.trim();
        
        // å¦‚æœç”¨æˆ¶æ²’æœ‰ä¿®æ”¹åç¨±ï¼Œä½¿ç”¨åŸå§‹å®Œæ•´åç¨±ï¼ˆé¿å…è‡ªå‹•æ·»åŠ å‰ç¶´å°è‡´é‡è¤‡ï¼‰
        // currentEditingRouteName ä¿å­˜çš„æ˜¯åŸå§‹å®Œæ•´åç¨±ï¼ˆåŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        // è¨ˆç®—ç·¨è¼¯æ¡†ä¸­æ‡‰è©²é¡¯ç¤ºçš„åŸå§‹åç¨±ï¼ˆä¸åŒ…å«ã€è·¯ç·šã€‘å‰ç¶´ï¼‰
        let originalDisplayName = '';
        if (currentEditingRouteName) {
            if (currentEditingRouteName.startsWith('ã€è·¯ç·šã€‘')) {
                originalDisplayName = currentEditingRouteName.substring(4); // ã€è·¯ç·šã€‘æ˜¯4å€‹å­—ç¬¦
            } else {
                originalDisplayName = currentEditingRouteName;
            }
        }
        
        // å¦‚æœç•¶å‰è¼¸å…¥çš„å€¼ç­‰æ–¼åŸå§‹é¡¯ç¤ºå€¼ï¼Œèªªæ˜ç”¨æˆ¶æ²’æœ‰ä¿®æ”¹
        if (originalDisplayName && routeName === originalDisplayName) {
            // ç”¨æˆ¶æ²’æœ‰ä¿®æ”¹åç¨±ï¼Œä½¿ç”¨åŸå§‹å®Œæ•´åç¨±
            routeName = currentEditingRouteName;
        } else {
            // ç”¨æˆ¶ä¿®æ”¹äº†åç¨±ï¼Œç¢ºä¿æœ‰ã€è·¯ç·šã€‘å‰ç¶´
            if (routeName && !routeName.startsWith('ã€è·¯ç·šã€‘')) {
                routeName = 'ã€è·¯ç·šã€‘' + routeName;
            }
        }

        // æ§‹å»º FormDataï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šå‚³ï¼‰
        formData.append('name', routeName);
        formData.append('grade', document.getElementById('editRouteGrade').value || '');
        const photoFile = document.getElementById('editRoutePhoto').files[0];
        if (photoFile) {
            formData.append('photo', photoFile);
        }
        formData.append('member_completions', JSON.stringify(memberCompletions));

        fetch(`/api/routes/${routeId}/`, {
            method: 'PATCH',
            body: formData
            // æ³¨æ„ï¼šä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®ï¼ˆåŒ…å« boundaryï¼‰
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditRouteModal();
                // å¼·åˆ¶åˆ·æ–°æ’è¡Œæ¦œå’Œè·¯ç·šåˆ—è¡¨
                setTimeout(function() {
                    refreshLeaderboard();
                }, 100);
                alert('è·¯ç·šæ›´æ–°æˆåŠŸï¼');
            } else {
                alert('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('æ›´æ–°è·¯ç·šå¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('æ›´æ–°è·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    });

    // æ–°å¢æˆå“¡è¡¨å–®æäº¤
    document.getElementById('addMemberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        // é©—è­‰æˆ¿é–“ ID
        const roomId = parseInt(ROOM_ID);
        if (isNaN(roomId) || roomId <= 0) {
            alert('éŒ¯èª¤ï¼šç„¡æ•ˆçš„æˆ¿é–“ IDã€‚è«‹åˆ·æ–°é é¢é‡è©¦ã€‚');
            return;
        }

        const data = {
            room: roomId, // ç¢ºä¿æ˜¯æ•´æ•¸é¡å‹
            name: formData.get('name'),
            is_custom_calc: document.getElementById('isCustomCalc').checked
        };

        console.log('Creating member with data:', data); // èª¿è©¦ä¿¡æ¯

        fetch('/api/members/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeAddMemberModal();
                refreshLeaderboard();
                loadMembersForRouteForm(); // åˆ·æ–°æˆå“¡åˆ—è¡¨ä¾›è·¯ç·šè¡¨å–®ä½¿ç”¨
                alert('æˆå“¡å‰µå»ºæˆåŠŸï¼');
            } else {
                alert('å‰µå»ºå¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('å‰µå»ºæˆå“¡å¤±æ•—:', error);
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'å‰µå»ºæˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤';
            if (error.name && error.name.length > 0) {
                // å¦‚æœæœ‰ name æ¬„ä½çš„éŒ¯èª¤ï¼ˆé‡è¤‡åç¨±ï¼‰
                errorMsg = error.name[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors) {
                errorMsg = error.non_field_errors[0];
            }
            alert(errorMsg);
        });
    });

    // ç·¨è¼¯æˆå“¡è¡¨å–®æäº¤
    document.getElementById('editMemberForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const memberId = document.getElementById('editMemberId').value;

        const data = {
            name: formData.get('name'),
            is_custom_calc: document.getElementById('editIsCustomCalc').checked
        };

        fetch(`/api/members/${memberId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeEditMemberModal();
                refreshLeaderboard();
                loadMembersForRouteForm(); // åˆ·æ–°æˆå“¡åˆ—è¡¨ä¾›è·¯ç·šè¡¨å–®ä½¿ç”¨
                alert('æˆå“¡æ›´æ–°æˆåŠŸï¼');
            } else {
                alert('æ›´æ–°å¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('æ›´æ–°æˆå“¡å¤±æ•—:', error);
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'æ›´æ–°æˆå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤';
            if (error.name && error.name.length > 0) {
                // å¦‚æœæœ‰ name æ¬„ä½çš„éŒ¯èª¤ï¼ˆé‡è¤‡åç¨±ï¼‰
                errorMsg = error.name[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors) {
                errorMsg = error.non_field_errors[0];
            }
            alert(errorMsg);
        });
    });

    document.getElementById('addRouteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // é©—è­‰é›£åº¦ç­‰ç´šæ˜¯å¦å·²é¸æ“‡
        const gradeValue = document.getElementById('routeGrade').value;
        if (!gradeValue || gradeValue.trim() === '') {
            alert('è«‹é¸æ“‡é›£åº¦ç­‰ç´š');
            document.getElementById('routeGrade').focus();
            return;
        }
        
        const formData = new FormData();
        const memberCompletions = {};
        
        // æ”¶é›†æˆå“¡å®Œæˆç‹€æ…‹
        const checkboxes = document.querySelectorAll('#memberCompletions input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            memberCompletions[checkbox.value] = checkbox.checked;
        });

        // ç¢ºä¿è·¯ç·šåç¨±æœ‰ã€è·¯ç·šã€‘å‰ç¶´
        let routeName = document.getElementById('routeName').value;
        if (routeName && !routeName.startsWith('ã€è·¯ç·šã€‘')) {
            routeName = 'ã€è·¯ç·šã€‘' + routeName;
        }

        // æ§‹å»º FormDataï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šå‚³ï¼‰
        formData.append('name', routeName);
        formData.append('grade', gradeValue);
        const photoFile = document.getElementById('routePhoto').files[0];
        if (photoFile) {
            formData.append('photo', photoFile);
        }
        formData.append('member_completions', JSON.stringify(memberCompletions));

        fetch(`/api/rooms/${ROOM_ID}/routes/`, {
            method: 'POST',
            body: formData
            // æ³¨æ„ï¼šä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®ï¼ˆåŒ…å« boundaryï¼‰
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                closeAddRouteModal();
                refreshLeaderboard();
                alert('è·¯ç·šå‰µå»ºæˆåŠŸï¼');
            } else {
                alert('å‰µå»ºå¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('å‰µå»ºè·¯ç·šå¤±æ•—:', error);
            // è™•ç†é©—è­‰éŒ¯èª¤
            let errorMsg = 'å‰µå»ºè·¯ç·šæ™‚ç™¼ç”ŸéŒ¯èª¤';
            if (error.grade && error.grade.length > 0) {
                // å¦‚æœæœ‰ grade æ¬„ä½çš„éŒ¯èª¤ï¼ˆå¿…å¡«é©—è­‰ï¼‰
                errorMsg = error.grade[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            } else if (error.non_field_errors) {
                errorMsg = error.non_field_errors[0];
            }
            alert(errorMsg);
        });
    });
</script>
{% endblock %}

