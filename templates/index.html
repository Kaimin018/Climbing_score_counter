{% extends 'base.html' %}
{% load static %}

{% block title %}é¦–é  - æ”€å²©è¨ˆåˆ†ç³»çµ±{% endblock %}

{% block content %}
<!-- æœªç™»éŒ„æ™‚é¡¯ç¤ºç™»éŒ„ç•Œé¢ -->
<div id="loginSection" class="login-container" style="display: none;">
    <div class="login-card">
        <!-- å·¦å´å“ç‰Œå€åŸŸï¼ˆæ¡Œé¢ç‰ˆï¼‰ -->
        <div class="login-brand-section">
            <div class="login-brand-icon">ğŸ§—</div>
            <h1>æ”€å²©è¨ˆåˆ†ç³»çµ±</h1>
            <p class="brand-subtitle">å°ˆæ¥­çš„æ”€å²©è·¯ç·šè¨ˆåˆ†èˆ‡æ’è¡Œæ¦œç®¡ç†</p>
            <ul class="brand-features">
                <li>å³æ™‚è¨ˆåˆ†èˆ‡æ’è¡Œæ¦œ</li>
                <li>è·¯ç·šç…§ç‰‡ç®¡ç†</li>
                <li>å¤šæˆ¿é–“æ”¯æ´</li>
                <li>è¡Œå‹•è£ç½®å„ªåŒ–</li>
            </ul>
        </div>
        
        <!-- å³å´è¡¨å–®å€åŸŸï¼ˆæ¡Œé¢ç‰ˆï¼‰ -->
        <div class="login-form-section">
            <!-- ç§»å‹•ç‰ˆæ¨™é¡Œï¼ˆæ¡Œé¢ç‰ˆéš±è—ï¼‰ -->
            <div class="login-header">
                <h1>æ”€å²©è¨ˆåˆ†ç³»çµ±</h1>
                <p class="subtitle">è«‹ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨</p>
            </div>
            
            <!-- æ¡Œé¢ç‰ˆè¡¨å–®å€åŸŸæ¨™é¡Œï¼ˆç§»å‹•ç‰ˆéš±è—ï¼‰ -->
            <div class="form-section-title">
                <h2>æ­¡è¿å›ä¾†</h2>
                <p>è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿä»¥ç¹¼çºŒä½¿ç”¨</p>
            </div>

            <div class="login-tabs">
                <button class="tab-btn active" id="loginTab" onclick="switchTab('login')">ç™»å…¥</button>
                <button class="tab-btn" id="registerTab" onclick="switchTab('register')">è¨»å†Š</button>
            </div>

            <!-- ç™»å…¥è¡¨å–® -->
            <div id="loginForm" class="form-container">
            <form id="loginFormElement">
                <div class="form-group">
                    <label for="loginUsername">ç”¨æˆ¶å:</label>
                    <input type="text" id="loginUsername" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">å¯†ç¢¼:</label>
                    <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
                </div>
                <div id="loginError" class="error-message" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-large" style="width: 100%;">
                    ğŸ” ç™»å…¥
                </button>
            </form>
            </div>

            <!-- è¨»å†Šè¡¨å–® -->
            <div id="registerForm" class="form-container" style="display: none;">
            <form id="registerFormElement">
                <div class="form-group">
                    <label for="registerUsername">ç”¨æˆ¶å:</label>
                    <input type="text" id="registerUsername" name="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="registerEmail">é›»å­éƒµä»¶ (é¸å¡«):</label>
                    <input type="email" id="registerEmail" name="email" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">å¯†ç¢¼:</label>
                    <input type="password" id="registerPassword" name="password" required autocomplete="new-password" oninput="validatePassword()">
                    <div class="password-rules" id="passwordRules">
                        <div class="password-rules-title">å¯†ç¢¼è¦å‰‡ï¼š</div>
                        <ul class="password-rules-list" id="passwordRulesList">
                            <li id="rule-length">è‡³å°‘ 8 å€‹å­—ç¬¦</li>
                            <li id="rule-uppercase">è‡³å°‘åŒ…å«ä¸€å€‹å¤§å¯«å­—æ¯ (A-Z)</li>
                            <li id="rule-lowercase">è‡³å°‘åŒ…å«ä¸€å€‹å°å¯«å­—æ¯ (a-z)</li>
                            <li id="rule-number">è‡³å°‘åŒ…å«ä¸€å€‹æ•¸å­— (0-9)</li>
                            <li id="rule-special">è‡³å°‘åŒ…å«ä¸€å€‹ç‰¹æ®Šå­—ç¬¦ (!@#$%^&*ç­‰)</li>
                        </ul>
                    </div>
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">ç¢ºèªå¯†ç¢¼:</label>
                    <input type="password" id="registerPasswordConfirm" name="password_confirm" required autocomplete="new-password" oninput="validatePasswordConfirm()">
                    <div id="passwordMatchMessage" style="margin-top: 8px; font-size: 0.9rem; display: none;"></div>
                </div>
                <div id="registerError" class="error-message" style="display: none;"></div>
                <button type="submit" class="btn btn-primary btn-large" style="width: 100%;" id="registerSubmitBtn">
                    âœ¨ è¨»å†Š
                </button>
            </form>
            </div>
            
            <!-- è¨ªå®¢ç™»å…¥æŒ‰éˆ•ï¼ˆåœ¨ç™»å…¥å’Œè¨»å†Šè¡¨å–®ä¸‹æ–¹ï¼‰ -->
            <div class="guest-login-section">
                <div class="guest-divider">
                    <span>æˆ–</span>
                </div>
                <button type="button" class="btn btn-secondary btn-large" id="guestLoginBtn" onclick="handleGuestLogin()" style="width: 100%;">
                    ğŸ‘¤ è¨ªå®¢ç™»å…¥
                </button>
                <p class="guest-note">è¨ªå®¢æ¨¡å¼ç„¡éœ€è¨»å†Šï¼Œå¯ç›´æ¥ä½¿ç”¨ç³»çµ±åŠŸèƒ½</p>
            </div>
        </div>
    </div>
</div>

<!-- å·²ç™»éŒ„æ™‚é¡¯ç¤ºæˆ¿é–“åˆ—è¡¨ -->
<div id="homeSection" class="home-container" style="display: none;">
    <div class="welcome-header">
        <h1>æ”€å²©è¨ˆåˆ†ç³»çµ±</h1>
        <p class="subtitle">é¸æ“‡æˆ¿é–“æˆ–å‰µå»ºæ–°æˆ¿é–“é–‹å§‹ä½¿ç”¨</p>
        <p style="text-align: center; margin-top: 10px;">
            <a href="/rules/" style="color: #3498db; text-decoration: none; font-size: 14px;">
                ğŸ“– æŸ¥çœ‹è¦å‰‡èªªæ˜
            </a>
        </p>
    </div>

    <div class="actions-section">
        <button class="btn btn-primary btn-large" onclick="showCreateRoomModal()">
            <span class="btn-icon">â•</span>
            å‰µå»ºæ–°æˆ¿é–“
        </button>
    </div>

    <div class="rooms-section">
        <h2>æˆ¿é–“åˆ—è¡¨</h2>
        <div id="roomsList" class="rooms-grid">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<!-- å‰µå»ºæˆ¿é–“å½ˆçª— -->
<div id="createRoomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å‰µå»ºæ–°æˆ¿é–“</h3>
            <span class="close" onclick="closeCreateRoomModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createRoomForm">
                <div class="form-group">
                    <label for="roomName">æˆ¿é–“åç¨±:</label>
                    <input type="text" id="roomName" name="name" required placeholder="ä¾‹å¦‚ï¼šé¢¨åŸ_YYYYMMDDæŒ‘æˆ°è³½">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºæˆ¿é–“</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateRoomModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æª¢æŸ¥ç”¨æˆ¶ç™»éŒ„ç‹€æ…‹
    function checkAuthStatus() {
        fetch('/api/auth/current-user/', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            console.log('æª¢æŸ¥ç™»éŒ„ç‹€æ…‹éŸ¿æ‡‰:', response.status, response.statusText);
            if (response.ok) {
                return response.json();
            } else if (response.status === 401 || response.status === 403) {
                // æœªèªè­‰ï¼Œé€™æ˜¯æ­£å¸¸æƒ…æ³
                throw new Error('æœªç™»éŒ„');
            } else {
                // å…¶ä»–éŒ¯èª¤
                console.error('æª¢æŸ¥ç™»éŒ„ç‹€æ…‹å¤±æ•—:', response.status, response.statusText);
                throw new Error(`æª¢æŸ¥ç™»éŒ„ç‹€æ…‹å¤±æ•—: ${response.status}`);
            }
        })
        .then(user => {
            console.log('ç•¶å‰ç”¨æˆ¶:', user);
            // å·²ç™»éŒ„ï¼Œé¡¯ç¤ºæˆ¿é–“åˆ—è¡¨
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('homeSection').style.display = 'block';
            loadRooms();
        })
        .catch(error => {
            console.log('æœªç™»éŒ„æˆ–æª¢æŸ¥å¤±æ•—:', error.message);
            // æœªç™»éŒ„ï¼Œé¡¯ç¤ºç™»éŒ„ç•Œé¢
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('homeSection').style.display = 'none';
        });
    }

    // è¨ªå®¢ç™»å…¥è™•ç†
    function handleGuestLogin() {
        const guestBtn = document.getElementById('guestLoginBtn');
        if (guestBtn) {
            guestBtn.disabled = true;
            guestBtn.textContent = 'ç™»å…¥ä¸­...';
        }

        // ç²å– CSRF token
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            console.error('CSRF token æœªæ‰¾åˆ°');
            alert('ç„¡æ³•ç²å–å®‰å…¨ä»¤ç‰Œï¼Œè«‹åˆ·æ–°é é¢å¾Œé‡è©¦');
            if (guestBtn) {
                guestBtn.disabled = false;
                guestBtn.textContent = 'ğŸ‘¤ è¨ªå®¢ç™»å…¥';
            }
            return;
        }

        fetch('/api/auth/guest-login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            credentials: 'include'
        })
        .then(response => {
            console.log('è¨ªå®¢ç™»å…¥éŸ¿æ‡‰ç‹€æ…‹:', response.status);
            if (response.ok) {
                return response.json();
            } else {
                // å˜—è©¦è§£æéŒ¯èª¤éŸ¿æ‡‰
                return response.json().then(err => {
                    console.error('è¨ªå®¢ç™»å…¥éŒ¯èª¤éŸ¿æ‡‰:', err);
                    return Promise.reject(err);
                }).catch(() => {
                    // å¦‚æœç„¡æ³•è§£æ JSONï¼Œè¿”å›ç‹€æ…‹æ–‡æœ¬
                    return Promise.reject({
                        error: `ç™»å…¥å¤±æ•— (ç‹€æ…‹ç¢¼: ${response.status})`,
                        status: response.status,
                        statusText: response.statusText
                    });
                });
            }
        })
        .then(data => {
            console.log('è¨ªå®¢ç™»å…¥æˆåŠŸ:', data);
            // è¨ªå®¢ç™»å…¥æˆåŠŸï¼Œç­‰å¾…ä¸€ä¸‹ç¢ºä¿ session å·²ä¿å­˜ï¼Œç„¶å¾Œé‡æ–°è¼‰å…¥é é¢
            setTimeout(() => {
                window.location.reload();
            }, 100);
        })
        .catch(error => {
            console.error('è¨ªå®¢ç™»å…¥å¤±æ•—:', error);
            let errorMsg = 'è¨ªå®¢ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦';
            
            if (error.error) {
                errorMsg = error.error;
            } else if (error.detail) {
                errorMsg = error.detail;
            } else if (error.message) {
                errorMsg = error.message;
            } else if (typeof error === 'string') {
                errorMsg = error;
            }
            
            alert(errorMsg);
            if (guestBtn) {
                guestBtn.disabled = false;
                guestBtn.textContent = 'ğŸ‘¤ è¨ªå®¢ç™»å…¥';
            }
        });
    }

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»éŒ„ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthStatus();
    });

    // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨™ç±¤
    function switchTab(tab) {
        if (tab === 'login') {
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        } else {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('registerError').style.display = 'none';
        // é‡ç½®å¯†ç¢¼é©—è­‰é¡¯ç¤º
        if (tab === 'register') {
            const passwordRules = document.querySelectorAll('.password-rules-list li');
            passwordRules.forEach(rule => {
                rule.classList.remove('valid', 'invalid');
            });
            const passwordMatchMessage = document.getElementById('passwordMatchMessage');
            if (passwordMatchMessage) {
                passwordMatchMessage.style.display = 'none';
            }
            // é‡ç½®è¨»å†ŠæŒ‰éˆ•ç‹€æ…‹
            const registerBtn = document.getElementById('registerSubmitBtn');
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.style.opacity = '1';
                registerBtn.style.cursor = 'pointer';
            }
        }
    }

    // ç™»å…¥è¡¨å–®æäº¤
    document.getElementById('loginFormElement').addEventListener('submit', function(e) {
        e.preventDefault();
        const errorDiv = document.getElementById('loginError');
        errorDiv.style.display = 'none';

        const formData = new FormData(e.target);
        const data = {
            username: formData.get('username'),
            password: formData.get('password')
        };

        fetch('/api/auth/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .then(data => {
            // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
            window.location.reload();
        })
        .catch(error => {
            console.error('ç™»å…¥å¤±æ•—:', error);
            const errorMsg = error.error || error.detail || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åå’Œå¯†ç¢¼';
            errorDiv.textContent = errorMsg;
            errorDiv.style.display = 'block';
        });
    });

    // è¨»å†Šè¡¨å–®æäº¤
    document.getElementById('registerFormElement').addEventListener('submit', function(e) {
        e.preventDefault();
        const errorDiv = document.getElementById('registerError');
        errorDiv.style.display = 'none';

        const formData = new FormData(e.target);
        const password = formData.get('password');
        const passwordConfirm = formData.get('password_confirm');

        // æª¢æŸ¥å¯†ç¢¼è¦å‰‡
        const rules = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };

        const allValid = Object.values(rules).every(rule => rule === true);
        if (!allValid) {
            errorDiv.textContent = 'å¯†ç¢¼ä¸ç¬¦åˆè¦å‰‡ï¼Œè«‹æª¢æŸ¥å¯†ç¢¼è¦å‰‡æç¤º';
            errorDiv.style.display = 'block';
            // è§¸ç™¼å‰ç«¯é©—è­‰é¡¯ç¤º
            validatePassword();
            return;
        }

        // æª¢æŸ¥å¯†ç¢¼æ˜¯å¦ä¸€è‡´
        if (password !== passwordConfirm) {
            errorDiv.textContent = 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´';
            errorDiv.style.display = 'block';
            validatePasswordConfirm();
            return;
        }

        const data = {
            username: formData.get('username'),
            email: formData.get('email') || '',
            password: password,
            password_confirm: passwordConfirm
        };

        fetch('/api/auth/register/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .then(data => {
            // è¨»å†ŠæˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
            window.location.reload();
        })
        .catch(error => {
            console.error('è¨»å†Šå¤±æ•—:', error);
            let errorMsg = 'è¨»å†Šå¤±æ•—';
            if (error.error) {
                errorMsg = error.error;
            } else if (error.username) {
                errorMsg = error.username[0];
            } else if (error.password) {
                errorMsg = error.password[0];
            } else if (error.password_confirm) {
                errorMsg = error.password_confirm[0];
            } else if (error.detail) {
                errorMsg = error.detail;
            }
            errorDiv.textContent = errorMsg;
            errorDiv.style.display = 'block';
        });
    });

    // ç²å– CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // å¯†ç¢¼é©—è­‰å‡½æ•¸
    function validatePassword() {
        const password = document.getElementById('registerPassword').value;
        const rules = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password),
            special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };

        // æ›´æ–°è¦å‰‡é¡¯ç¤º
        updateRuleStatus('rule-length', rules.length);
        updateRuleStatus('rule-uppercase', rules.uppercase);
        updateRuleStatus('rule-lowercase', rules.lowercase);
        updateRuleStatus('rule-number', rules.number);
        updateRuleStatus('rule-special', rules.special);

        // æª¢æŸ¥æ‰€æœ‰è¦å‰‡æ˜¯å¦æ»¿è¶³
        const allValid = Object.values(rules).every(rule => rule === true);
        
        // æ›´æ–°è¨»å†ŠæŒ‰éˆ•ç‹€æ…‹
        const registerBtn = document.getElementById('registerSubmitBtn');
        if (registerBtn) {
            if (allValid && password.length > 0) {
                registerBtn.disabled = false;
                registerBtn.style.opacity = '1';
                registerBtn.style.cursor = 'pointer';
            } else {
                registerBtn.disabled = true;
                registerBtn.style.opacity = '0.6';
                registerBtn.style.cursor = 'not-allowed';
            }
        }

        // å¦‚æœå¯†ç¢¼ç¢ºèªæ¬„ä½æœ‰å€¼ï¼Œä¹Ÿé©—è­‰ç¢ºèªå¯†ç¢¼
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        if (passwordConfirm) {
            validatePasswordConfirm();
        }
    }

    // æ›´æ–°è¦å‰‡ç‹€æ…‹é¡¯ç¤º
    function updateRuleStatus(ruleId, isValid) {
        const ruleElement = document.getElementById(ruleId);
        if (ruleElement) {
            ruleElement.classList.remove('valid', 'invalid');
            if (isValid) {
                ruleElement.classList.add('valid');
            } else {
                ruleElement.classList.add('invalid');
            }
        }
    }

    // é©—è­‰ç¢ºèªå¯†ç¢¼
    function validatePasswordConfirm() {
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        const messageDiv = document.getElementById('passwordMatchMessage');

        if (passwordConfirm.length === 0) {
            messageDiv.style.display = 'none';
            return;
        }

        if (password === passwordConfirm) {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#27ae60';
            messageDiv.textContent = 'âœ“ å¯†ç¢¼ä¸€è‡´';
        } else {
            messageDiv.style.display = 'block';
            messageDiv.style.color = '#e74c3c';
            messageDiv.textContent = 'âœ— å¯†ç¢¼ä¸ä¸€è‡´';
        }
    }

    function setupRoomNameExample() {
        // ç²å–ç•¶å‰æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYYMMDD
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateStr = year + month + day;
        
        // è¨­ç½®ç¯„ä¾‹æ–‡å­—ç‚ºé è¨­å€¼ï¼ˆç”¨æˆ¶å¯ä»¥ç›´æ¥é¸å–å’Œä¿®æ”¹ï¼‰
        const roomNameInput = document.getElementById('roomName');
        if (roomNameInput) {
            const template = roomNameInput.placeholder || 'ä¾‹å¦‚ï¼šé¢¨åŸ_YYYYMMDDæŒ‘æˆ°è³½';
            const exampleText = template.replace('ä¾‹å¦‚ï¼š', '').replace('YYYYMMDD', dateStr);
            roomNameInput.value = exampleText;
            // é¸å–æ‰€æœ‰æ–‡å­—ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç›´æ¥ä¿®æ”¹
            roomNameInput.select();
        }
    }

    function loadRooms() {
        fetch('/api/rooms/')
            .then(response => response.json())
            .then(data => {
                displayRooms(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆ¿é–“åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('roomsList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</div>';
            });
    }

    function displayRooms(rooms) {
        const container = document.getElementById('roomsList');
        
        if (!rooms || rooms.length === 0) {
            container.innerHTML = '<div class="empty">å°šç„¡æˆ¿é–“ï¼Œè«‹å‰µå»ºä¸€å€‹æ–°æˆ¿é–“é–‹å§‹ä½¿ç”¨</div>';
            return;
        }

        container.innerHTML = rooms.map(room => {
            const memberCount = room.members ? room.members.length : 0;
            const routeCount = room.routes ? room.routes.length : 0;
            return `
                <div class="room-card" onclick="enterRoom(${room.id})">
                    <div class="room-card-header">
                        <h3>${room.name}</h3>
                        <span class="room-id">ID: ${room.id}</span>
                    </div>
                    <div class="room-card-info">
                        <div class="info-item">
                            <span class="label">æ¯ä¸€æ¢ç·šç¸½åˆ† (L):</span>
                            <span class="value">${room.standard_line_score}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">æˆå“¡æ•¸:</span>
                            <span class="value">${memberCount}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">è·¯ç·šæ•¸:</span>
                            <span class="value">${routeCount}</span>
                        </div>
                    </div>
                    <div class="room-card-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); enterRoom(${room.id})">
                            é€²å…¥æˆ¿é–“
                        </button>
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteRoom(${room.id}, '${room.name}')">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function enterRoom(roomId) {
        window.location.href = `/leaderboard/${roomId}/`;
    }

    function deleteRoom(roomId, roomName) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤æˆ¿é–“ "${roomName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²æˆ¿é–“çš„æ‰€æœ‰æ•¸æ“šï¼ˆæˆå“¡ã€è·¯ç·šã€æˆç¸¾ï¼‰ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }

        fetch(`/api/rooms/${roomId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.status === 204 || response.ok) {
                alert('æˆ¿é–“å·²åˆªé™¤');
                loadRooms(); // åˆ·æ–°æˆ¿é–“åˆ—è¡¨
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤æˆ¿é–“å¤±æ•—:', error);
            alert('åˆªé™¤æˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤');
        });
    }

    function showCreateRoomModal() {
        document.getElementById('createRoomModal').style.display = 'block';
        // è¨­ç½®ç¯„ä¾‹æ–‡å­—ç‚ºé è¨­å€¼ï¼ˆè‡ªå‹•é¸å–ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç›´æ¥ä¿®æ”¹ï¼‰
        setTimeout(function() {
            setupRoomNameExample();
        }, 100); // ç¨å»¶é²ç¢ºä¿ DOM å·²å®Œå…¨è¼‰å…¥
    }

    function closeCreateRoomModal() {
        document.getElementById('createRoomModal').style.display = 'none';
        document.getElementById('createRoomForm').reset();
    }

    // é—œé–‰å½ˆçª—ï¼ˆé»æ“Šå¤–éƒ¨ï¼‰
    window.onclick = function(event) {
        const modal = document.getElementById('createRoomModal');
        if (event.target === modal) {
            closeCreateRoomModal();
        }
    }

    // å‰µå»ºæˆ¿é–“è¡¨å–®æäº¤
    document.getElementById('createRoomForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name')
            // standard_line_score æœƒè‡ªå‹•è¨ˆç®—ï¼Œä¸éœ€è¦ç™¼é€
        };

        fetch('/api/rooms/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeCreateRoomModal();
                loadRooms();
                alert('æˆ¿é–“å‰µå»ºæˆåŠŸï¼');
                // å¯é¸ï¼šè‡ªå‹•é€²å…¥æ–°å‰µå»ºçš„æˆ¿é–“
                setTimeout(() => {
                    enterRoom(data.id);
                }, 500);
            } else {
                alert('å‰µå»ºå¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('å‰µå»ºæˆ¿é–“å¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('å‰µå»ºæˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    });
</script>
{% endblock %}

