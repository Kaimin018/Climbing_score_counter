{% extends 'base.html' %}
{% load static %}

{% block title %}é¦–é  - æ”€å²©è¨ˆåˆ†ç³»çµ±{% endblock %}

{% block content %}
<div class="home-container">
    <div class="welcome-header">
        <h1>æ”€å²©è¨ˆåˆ†ç³»çµ±</h1>
        <p class="subtitle">é¸æ“‡æˆ¿é–“æˆ–å‰µå»ºæ–°æˆ¿é–“é–‹å§‹ä½¿ç”¨</p>
        <p style="text-align: center; margin-top: 10px;">
            <a href="/rules/" style="color: #3498db; text-decoration: none; font-size: 14px;">
                ğŸ“– æŸ¥çœ‹è¦å‰‡èªªæ˜
            </a>
        </p>
    </div>

    <div class="actions-section">
        <button class="btn btn-primary btn-large" onclick="showCreateRoomModal()">
            <span class="btn-icon">â•</span>
            å‰µå»ºæ–°æˆ¿é–“
        </button>
    </div>

    <div class="rooms-section">
        <h2>æˆ¿é–“åˆ—è¡¨</h2>
        <div id="roomsList" class="rooms-grid">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<!-- å‰µå»ºæˆ¿é–“å½ˆçª— -->
<div id="createRoomModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å‰µå»ºæ–°æˆ¿é–“</h3>
            <span class="close" onclick="closeCreateRoomModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="createRoomForm">
                <div class="form-group">
                    <label for="roomName">æˆ¿é–“åç¨±:</label>
                    <input type="text" id="roomName" name="name" required placeholder="ä¾‹å¦‚ï¼šé¢¨åŸ_YYYYMMDDæŒ‘æˆ°è³½">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‰µå»ºæˆ¿é–“</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateRoomModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // é é¢è¼‰å…¥æ™‚ç²å–æˆ¿é–“åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        loadRooms();
    });

    function setupRoomNameExample() {
        // ç²å–ç•¶å‰æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYYMMDD
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateStr = year + month + day;
        
        // è¨­ç½®ç¯„ä¾‹æ–‡å­—ç‚ºé è¨­å€¼ï¼ˆç”¨æˆ¶å¯ä»¥ç›´æ¥é¸å–å’Œä¿®æ”¹ï¼‰
        const roomNameInput = document.getElementById('roomName');
        if (roomNameInput) {
            const template = roomNameInput.placeholder || 'ä¾‹å¦‚ï¼šé¢¨åŸ_YYYYMMDDæŒ‘æˆ°è³½';
            const exampleText = template.replace('ä¾‹å¦‚ï¼š', '').replace('YYYYMMDD', dateStr);
            roomNameInput.value = exampleText;
            // é¸å–æ‰€æœ‰æ–‡å­—ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç›´æ¥ä¿®æ”¹
            roomNameInput.select();
        }
    }

    function loadRooms() {
        fetch('/api/rooms/')
            .then(response => response.json())
            .then(data => {
                displayRooms(data);
            })
            .catch(error => {
                console.error('è¼‰å…¥æˆ¿é–“åˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('roomsList').innerHTML = 
                    '<div class="error">è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢</div>';
            });
    }

    function displayRooms(rooms) {
        const container = document.getElementById('roomsList');
        
        if (!rooms || rooms.length === 0) {
            container.innerHTML = '<div class="empty">å°šç„¡æˆ¿é–“ï¼Œè«‹å‰µå»ºä¸€å€‹æ–°æˆ¿é–“é–‹å§‹ä½¿ç”¨</div>';
            return;
        }

        container.innerHTML = rooms.map(room => {
            const memberCount = room.members ? room.members.length : 0;
            const routeCount = room.routes ? room.routes.length : 0;
            return `
                <div class="room-card" onclick="enterRoom(${room.id})">
                    <div class="room-card-header">
                        <h3>${room.name}</h3>
                        <span class="room-id">ID: ${room.id}</span>
                    </div>
                    <div class="room-card-info">
                        <div class="info-item">
                            <span class="label">æ¯ä¸€æ¢ç·šç¸½åˆ† (L):</span>
                            <span class="value">${room.standard_line_score}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">æˆå“¡æ•¸:</span>
                            <span class="value">${memberCount}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">è·¯ç·šæ•¸:</span>
                            <span class="value">${routeCount}</span>
                        </div>
                    </div>
                    <div class="room-card-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); enterRoom(${room.id})">
                            é€²å…¥æˆ¿é–“
                        </button>
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteRoom(${room.id}, '${room.name}')">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function enterRoom(roomId) {
        window.location.href = `/leaderboard/${roomId}/`;
    }

    function deleteRoom(roomId, roomName) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤æˆ¿é–“ "${roomName}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åˆªé™¤è©²æˆ¿é–“çš„æ‰€æœ‰æ•¸æ“šï¼ˆæˆå“¡ã€è·¯ç·šã€æˆç¸¾ï¼‰ï¼Œä¸”ç„¡æ³•æ¢å¾©ï¼`)) {
            return;
        }

        fetch(`/api/rooms/${roomId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.status === 204 || response.ok) {
                alert('æˆ¿é–“å·²åˆªé™¤');
                loadRooms(); // åˆ·æ–°æˆ¿é–“åˆ—è¡¨
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .catch(error => {
            console.error('åˆªé™¤æˆ¿é–“å¤±æ•—:', error);
            alert('åˆªé™¤æˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤');
        });
    }

    function showCreateRoomModal() {
        document.getElementById('createRoomModal').style.display = 'block';
        // è¨­ç½®ç¯„ä¾‹æ–‡å­—ç‚ºé è¨­å€¼ï¼ˆè‡ªå‹•é¸å–ï¼Œæ–¹ä¾¿ç”¨æˆ¶ç›´æ¥ä¿®æ”¹ï¼‰
        setTimeout(function() {
            setupRoomNameExample();
        }, 100); // ç¨å»¶é²ç¢ºä¿ DOM å·²å®Œå…¨è¼‰å…¥
    }

    function closeCreateRoomModal() {
        document.getElementById('createRoomModal').style.display = 'none';
        document.getElementById('createRoomForm').reset();
    }

    // é—œé–‰å½ˆçª—ï¼ˆé»æ“Šå¤–éƒ¨ï¼‰
    window.onclick = function(event) {
        const modal = document.getElementById('createRoomModal');
        if (event.target === modal) {
            closeCreateRoomModal();
        }
    }

    // å‰µå»ºæˆ¿é–“è¡¨å–®æäº¤
    document.getElementById('createRoomForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            name: formData.get('name')
            // standard_line_score æœƒè‡ªå‹•è¨ˆç®—ï¼Œä¸éœ€è¦ç™¼é€
        };

        fetch('/api/rooms/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.id) {
                closeCreateRoomModal();
                loadRooms();
                alert('æˆ¿é–“å‰µå»ºæˆåŠŸï¼');
                // å¯é¸ï¼šè‡ªå‹•é€²å…¥æ–°å‰µå»ºçš„æˆ¿é–“
                setTimeout(() => {
                    enterRoom(data.id);
                }, 500);
            } else {
                alert('å‰µå»ºå¤±æ•—: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('å‰µå»ºæˆ¿é–“å¤±æ•—:', error);
            const errorMsg = error.detail || error.message || JSON.stringify(error);
            alert('å‰µå»ºæˆ¿é–“æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + errorMsg);
        });
    });
</script>
{% endblock %}

