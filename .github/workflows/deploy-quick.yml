# ============================================================================
# å¿«é€Ÿéƒ¨ç½²å·¥ä½œæµ (Quick Deploy Workflow)
# ============================================================================
#
# ç”¨é€”è¯´æ˜ï¼š
#   è¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿéƒ¨ç½²å·¥ä½œæµï¼Œä¸»è¦ç”¨äºæµ‹è¯•ç¯å¢ƒæˆ–éœ€è¦å¿«é€Ÿéƒ¨ç½²çš„åœºæ™¯ã€‚
#   ç›¸æ¯” deploy.ymlï¼Œå®ƒè·³è¿‡äº†æµ‹è¯•æ­¥éª¤ï¼Œéƒ¨ç½²é€Ÿåº¦æ›´å¿«ã€‚
#
# ä¸ deploy.yml çš„ä¸»è¦å·®å¼‚ï¼š
#
#   1. è§¦å‘æ–¹å¼ï¼š
#      - deploy.yml: è‡ªåŠ¨è§¦å‘ï¼ˆpush åˆ° main/masterï¼‰+ æ‰‹åŠ¨è§¦å‘
#      - deploy-quick.yml: ä»…æ‰‹åŠ¨è§¦å‘
#
#   2. æµ‹è¯•æ‰§è¡Œï¼š
#      - deploy.yml: å¿…é¡»è¿è¡Œæµ‹è¯•ï¼ˆç¡®ä¿ä»£ç è´¨é‡ï¼‰
#      - deploy-quick.yml: é»˜è®¤è·³è¿‡æµ‹è¯•ï¼ˆå¿«é€Ÿéƒ¨ç½²ï¼‰
#
#   3. åˆ†æ”¯é€‰æ‹©ï¼š
#      - deploy.yml: å›ºå®šéƒ¨ç½² main/master åˆ†æ”¯
#      - deploy-quick.yml: å¯é€‰æ‹©åˆ†æ”¯ï¼ˆmain/master/developï¼‰
#
#   4. è¯Šæ–­è¯¦ç»†ç¨‹åº¦ï¼š
#      - deploy.yml: è¯¦ç»†çš„è¯Šæ–­ã€éªŒè¯å’Œé”™è¯¯å¤„ç†
#      - deploy-quick.yml: åŸºæœ¬çš„è¯Šæ–­å’ŒéªŒè¯ï¼ˆä¿æŒç®€å•å¿«é€Ÿï¼‰
#
#   5. é€‚ç”¨åœºæ™¯ï¼š
#      - deploy.yml: ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²ã€æ­£å¼å‘å¸ƒ
#      - deploy-quick.yml: æµ‹è¯•ç¯å¢ƒéƒ¨ç½²ã€å¼€å‘åˆ†æ”¯éƒ¨ç½²ã€ç´§æ€¥ä¿®å¤
#
# ä½¿ç”¨å»ºè®®ï¼š
#   - ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ deploy.ymlï¼ˆè‡ªåŠ¨éƒ¨ç½²ï¼ŒåŒ…å«å®Œæ•´æµ‹è¯•ï¼‰
#   - æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨ deploy-quick.ymlï¼ˆå¿«é€Ÿéƒ¨ç½²ï¼Œè·³è¿‡æµ‹è¯•ï¼‰
#   - å¼€å‘åˆ†æ”¯ï¼šä½¿ç”¨ deploy-quick.ymlï¼ˆå¯é€‰æ‹©åˆ†æ”¯ï¼‰
#
# ============================================================================

name: Quick Deploy to AWS EC2 (Skip Tests)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - master
          - dev
      skip_tests:
        description: 'è·³éæ¸¬è©¦ï¼ˆå¿«é€Ÿéƒ¨ç½²ï¼‰'
        required: false
        default: true
        type: boolean

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Quick Deploy (Skip Tests)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0
    
    - name: Set up Python
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y libjpeg-dev zlib1g-dev libheif-dev libde265-dev libfreetype6-dev
    
    - name: Install Python dependencies
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run migrations
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      env:
        DEBUG: 'True'
      run: |
        export SECRET_KEY="${{ secrets.SECRET_KEY || 'django-insecure-climbing-score-system-dev-key-change-in-production' }}"
        python manage.py migrate --noinput
    
    - name: Run tests
      if: ${{ github.event.inputs.skip_tests != 'true' }}
      env:
        DEBUG: 'True'
      run: |
        export SECRET_KEY="${{ secrets.SECRET_KEY || 'django-insecure-climbing-score-system-dev-key-change-in-production' }}"
        python manage.py test scoring.tests --verbosity=0
    
    - name: Configure SSH
      run: |
        EC2_HOST="${{ secrets.EC2_HOST || '' }}"
        EC2_USER="${{ secrets.EC2_USER || '' }}"
        EC2_SSH_KEY="${{ secrets.EC2_SSH_KEY || '' }}"
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ]; then
          echo "âš ï¸  è·³é SSH é…ç½®ï¼šæœªé…ç½® EC2 secrets"
          exit 0
        fi
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts || true
    
    - name: Quick Deploy to EC2
      env:
        DEPLOY_BRANCH: ${{ github.event.inputs.branch }}
      run: |
        EC2_USER="${{ secrets.EC2_USER || '' }}"
        EC2_HOST="${{ secrets.EC2_HOST || '' }}"
        EC2_SSH_KEY="${{ secrets.EC2_SSH_KEY || '' }}"
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ]; then
          echo "âš ï¸  è·³ééƒ¨ç½²ï¼šæœªé…ç½® EC2 secrets"
          echo "è«‹æª¢æŸ¥ GitHub Secrets é…ç½®ï¼š"
          echo "  - EC2_HOST: ${EC2_HOST:-æœªè¨­ç½®}"
          echo "  - EC2_USER: ${EC2_USER:-æœªè¨­ç½®}"
          echo "  - EC2_SSH_KEY: ${EC2_SSH_KEY:+å·²è¨­ç½®}${EC2_SSH_KEY:-æœªè¨­ç½®}"
          exit 0
        fi
        echo "é–‹å§‹å¿«é€Ÿéƒ¨ç½²åˆ° EC2..."
        echo "ç›®æ¨™: ${EC2_USER}@${EC2_HOST}"
        echo "åˆ†æ”¯: ${DEPLOY_BRANCH}"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${EC2_USER}@${EC2_HOST} "DEPLOY_BRANCH='${DEPLOY_BRANCH}' bash -s" << 'ENDSSH'
          set -e
          set -o pipefail
          
          # é€²å…¥é …ç›®ç›®éŒ„
          cd /var/www/Climbing_score_counter || {
            echo "âŒ éŒ¯èª¤: ç„¡æ³•é€²å…¥é …ç›®ç›®éŒ„ /var/www/Climbing_score_counter"
            exit 1
          }
          
          echo "=== é–‹å§‹å¿«é€Ÿéƒ¨ç½² ==="
          echo "åˆ†æ”¯: ${DEPLOY_BRANCH}"
          echo "æ™‚é–“: $(date)"
          echo "ç•¶å‰ç›®éŒ„: $(pwd)"
          echo "ç•¶å‰ç”¨æˆ¶: $(whoami)"
          
          # è¨˜éŒ„éƒ¨ç½²å‰çš„ä»£ç¢¼ç‰ˆæœ¬
          OLD_COMMIT=""
          if [ -d ".git" ]; then
            OLD_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            echo "ğŸ“Œ éƒ¨ç½²å‰ä»£ç¢¼ç‰ˆæœ¬: $OLD_COMMIT"
            
            # é…ç½® Git å®‰å…¨ç›®éŒ„
            git config --global --add safe.directory /var/www/Climbing_score_counter || true
            
            # ä¿®å¾© .git ç›®éŒ„æ¬Šé™
            CURRENT_USER=$(whoami)
            if [ ! -w ".git" ] 2>/dev/null; then
              sudo chown -R $CURRENT_USER:$CURRENT_USER .git 2>/dev/null || true
            fi
          fi
          
          # æ‹‰å–æŒ‡å®šåˆ†æ”¯çš„æœ€æ–°ä»£ç¢¼
          if [ -d ".git" ]; then
            echo "ğŸ“¥ æ‹‰å–åˆ†æ”¯ ${DEPLOY_BRANCH} çš„æœ€æ–°ä»£ç¢¼..."
            
            # æª¢æŸ¥é ç¨‹é…ç½®
            if ! git remote get-url origin >/dev/null 2>&1; then
              echo "âŒ éŒ¯èª¤: æœªé…ç½®é ç¨‹å€‰åº« origin"
              exit 1
            fi
            REMOTE_URL=$(git remote get-url origin)
            echo "   é ç¨‹å€‰åº«: $REMOTE_URL"
            
            # ç²å–æœ€æ–°ä»£ç¢¼ï¼ˆæ˜ç¢ºæŒ‡å®šåˆ†æ”¯ï¼Œä¸¦æ·»åŠ é‡è©¦æ©Ÿåˆ¶ï¼‰
            FETCH_SUCCESS=false
            for i in 1 2 3; do
              echo "   å˜—è©¦ç²å–åˆ†æ”¯ ${DEPLOY_BRANCH} ($i/3)..."
              if git fetch origin ${DEPLOY_BRANCH} 2>&1; then
                FETCH_SUCCESS=true
                echo "   âœ… Git fetch æˆåŠŸ"
                break
              else
                FETCH_ERROR=$?
                echo "   âš ï¸  å˜—è©¦ $i å¤±æ•—ï¼Œé€€å‡ºç¢¼: $FETCH_ERROR"
                if [ $i -lt 3 ]; then
                  echo "   ç­‰å¾… 2 ç§’å¾Œé‡è©¦..."
                  sleep 2
                fi
              fi
            done
            
            if [ "$FETCH_SUCCESS" = "false" ]; then
              echo "   âŒ æ‰€æœ‰ Git fetch å˜—è©¦éƒ½å¤±æ•—"
              echo "   è¨ºæ–·ä¿¡æ¯:"
              echo "   é ç¨‹ URL: $(git remote get-url origin 2>/dev/null || echo 'ç„¡æ³•ç²å–')"
              echo "   ç›®æ¨™åˆ†æ”¯: ${DEPLOY_BRANCH}"
              echo "   å¯ç”¨çš„é ç¨‹åˆ†æ”¯:"
              git branch -r 2>/dev/null | head -10 || echo "   ç„¡æ³•ç²å–é ç¨‹åˆ†æ”¯åˆ—è¡¨"
              exit 1
            fi
            
            # é©—è­‰é ç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            if ! git rev-parse --verify origin/${DEPLOY_BRANCH} >/dev/null 2>&1; then
              echo "âŒ éŒ¯èª¤: é ç¨‹åˆ†æ”¯ origin/${DEPLOY_BRANCH} ä¸å­˜åœ¨"
              echo "   å¯ç”¨çš„é ç¨‹åˆ†æ”¯:"
              git branch -r 2>/dev/null | head -10
              exit 1
            fi
            REMOTE_COMMIT=$(git rev-parse --short origin/${DEPLOY_BRANCH} 2>/dev/null || echo "unknown")
            echo "   âœ… æ‰¾åˆ°é ç¨‹åˆ†æ”¯ origin/${DEPLOY_BRANCH}: $REMOTE_COMMIT"
            
            # åˆ‡æ›åˆ°æŒ‡å®šåˆ†æ”¯
            CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
            if [ "$CURRENT_BRANCH" != "${DEPLOY_BRANCH}" ]; then
              echo "ğŸ”„ åˆ‡æ›åˆ†æ”¯: $CURRENT_BRANCH -> ${DEPLOY_BRANCH}"
              if git checkout ${DEPLOY_BRANCH} 2>/dev/null; then
                echo "   âœ… å·²åˆ‡æ›åˆ°åˆ†æ”¯ ${DEPLOY_BRANCH}"
              elif git checkout -b ${DEPLOY_BRANCH} origin/${DEPLOY_BRANCH} 2>/dev/null; then
                echo "   âœ… å·²å‰µå»ºä¸¦åˆ‡æ›åˆ°åˆ†æ”¯ ${DEPLOY_BRANCH}"
              else
                echo "âŒ éŒ¯èª¤: ç„¡æ³•åˆ‡æ›åˆ°åˆ†æ”¯ ${DEPLOY_BRANCH}"
                exit 1
              fi
            fi
            
            # è™•ç†æ•¸æ“šåº«æ–‡ä»¶è¡çª
            if [ -f "db.sqlite3" ] && ! git diff --quiet db.sqlite3 2>/dev/null; then
              echo "â„¹ï¸  æª¢æ¸¬åˆ°æ•¸æ“šåº«æ–‡ä»¶è®Šæ›´ï¼Œå‚™ä»½å¾Œé‡ç½®"
              mkdir -p backups
              cp db.sqlite3 backups/db_backup_$(date +%Y%m%d_%H%M%S).sqlite3 2>/dev/null || true
              git checkout -- db.sqlite3 2>/dev/null || true
            fi
            
            # é‡ç½®åˆ°é ç¨‹åˆ†æ”¯ï¼ˆç¢ºä¿ç²å–æœ€æ–°ä»£ç¢¼ï¼‰
            echo "ğŸ”„ é‡ç½®åˆ° origin/${DEPLOY_BRANCH} ($REMOTE_COMMIT)..."
            if git reset --hard origin/${DEPLOY_BRANCH} 2>&1; then
              echo "âœ… å·²é‡ç½®åˆ° origin/${DEPLOY_BRANCH}"
            else
              RESET_ERROR=$?
              echo "âŒ éŒ¯èª¤: git reset å¤±æ•—ï¼Œé€€å‡ºç¢¼: $RESET_ERROR"
              exit $RESET_ERROR
            fi
            
            # é©—è­‰æ›´æ–°çµæœ
            NEW_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            echo "ğŸ“Œ éƒ¨ç½²å¾Œä»£ç¢¼ç‰ˆæœ¬: $NEW_COMMIT"
            echo "ğŸ“Œ é ç¨‹æœ€æ–°ç‰ˆæœ¬: $REMOTE_COMMIT"
            
            if [ "$NEW_COMMIT" != "$REMOTE_COMMIT" ]; then
              echo "âš ï¸  è­¦å‘Š: æœ¬åœ°ç‰ˆæœ¬ ($NEW_COMMIT) èˆ‡é ç¨‹ç‰ˆæœ¬ ($REMOTE_COMMIT) ä¸ä¸€è‡´"
            fi
            
            if [ "$OLD_COMMIT" != "unknown" ] && [ "$NEW_COMMIT" != "unknown" ] && [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
              echo "âœ… ä»£ç¢¼å·²æ›´æ–°: $OLD_COMMIT -> $NEW_COMMIT"
              echo "   æœ€æ–°æäº¤ä¿¡æ¯:"
              git log -1 --oneline 2>/dev/null || true
            elif [ "$OLD_COMMIT" = "$NEW_COMMIT" ]; then
              echo "â„¹ï¸  ä»£ç¢¼ç‰ˆæœ¬æœªè®Šæ›´ï¼ˆå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼‰"
            fi
          else
            echo "âš ï¸  è­¦å‘Š: æœªæª¢æ¸¬åˆ° Git å€‰åº«ï¼Œè·³éä»£ç¢¼æ›´æ–°"
          fi
          
          # åŸ·è¡Œéƒ¨ç½²è…³æœ¬
          echo ""
          echo "ğŸš€ åŸ·è¡Œéƒ¨ç½²è…³æœ¬..."
          DEPLOY_SCRIPT="Deployment/scripts/tools/deploy.sh"
          
          if [ ! -f "$DEPLOY_SCRIPT" ]; then
            echo "âŒ éŒ¯èª¤: æ‰¾ä¸åˆ°éƒ¨ç½²è…³æœ¬ $DEPLOY_SCRIPT"
            echo "ç•¶å‰ç›®éŒ„: $(pwd)"
            echo "ç›®éŒ„å…§å®¹:"
            ls -la | head -20
            echo ""
            echo "Deployment ç›®éŒ„å…§å®¹:"
            ls -la Deployment/ 2>/dev/null || echo "Deployment ç›®éŒ„ä¸å­˜åœ¨"
            echo ""
            echo "Deployment/scripts ç›®éŒ„å…§å®¹:"
            ls -la Deployment/scripts/ 2>/dev/null || echo "Deployment/scripts ç›®éŒ„ä¸å­˜åœ¨"
            echo ""
            echo "Deployment/scripts/tools ç›®éŒ„å…§å®¹:"
            ls -la Deployment/scripts/tools/ 2>/dev/null || echo "Deployment/scripts/tools ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç¢ºä¿è…³æœ¬æœ‰åŸ·è¡Œæ¬Šé™
          chmod +x "$DEPLOY_SCRIPT"
          
          # åŸ·è¡Œéƒ¨ç½²è…³æœ¬ï¼ˆè·³é Git æ›´æ–°ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“åœ¨ä¸Šé¢è™•ç†äº†ï¼‰
          # è¨­ç½®ç’°å¢ƒè®Šæ•¸å‘Šè¨´ deploy.sh è·³é Git æ›´æ–°
          echo "åŸ·è¡Œ: bash $DEPLOY_SCRIPT (è·³é Git æ›´æ–°)"
          export SKIP_GIT_UPDATE=true
          if bash "$DEPLOY_SCRIPT"; then
            echo "âœ… éƒ¨ç½²è…³æœ¬åŸ·è¡ŒæˆåŠŸ"
          else
            EXIT_CODE=$?
            echo "âŒ éƒ¨ç½²è…³æœ¬åŸ·è¡Œå¤±æ•—ï¼Œé€€å‡ºç¢¼: $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          # ç­‰å¾…æœå‹™å•Ÿå‹•
          echo ""
          echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•ï¼ˆ3ç§’ï¼‰..."
          sleep 3
          
          # é©—è­‰æœå‹™ç‹€æ…‹
          echo ""
          echo "ğŸ“Š æœå‹™ç‹€æ…‹æª¢æŸ¥:"
          if sudo systemctl is-active --quiet climbing_system; then
            echo "âœ… climbing_system æœå‹™æ­£åœ¨é‹è¡Œ"
          else
            echo "âš ï¸  è­¦å‘Š: climbing_system æœå‹™æœªé‹è¡Œï¼Œå˜—è©¦å•Ÿå‹•..."
            sudo systemctl start climbing_system || true
            sleep 2
            if sudo systemctl is-active --quiet climbing_system; then
              echo "âœ… æœå‹™å·²å•Ÿå‹•"
            else
              echo "âŒ æœå‹™å•Ÿå‹•å¤±æ•—"
              sudo journalctl -u climbing_system --no-pager -n 20 || true
              exit 1
            fi
          fi
          
          echo ""
          echo "=== å¿«é€Ÿéƒ¨ç½²å®Œæˆ ==="
          echo "æ™‚é–“: $(date)"
          echo "âœ… éƒ¨ç½²å®Œæˆ"
        ENDSSH

