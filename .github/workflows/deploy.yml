name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  AWS_REGION: us-east-1  # æ ¹æ“šæ‚¨çš„ EC2 å€åŸŸä¿®æ”¹

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libjpeg-dev zlib1g-dev libheif-dev libde265-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run migrations
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DEBUG: 'False'
      run: |
        export SECRET_KEY=${SECRET_KEY:-django-insecure-climbing-score-system-dev-key-change-in-production}
        python manage.py migrate --noinput
    
    - name: Run tests
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DEBUG: 'True'
      run: |
        export SECRET_KEY=${SECRET_KEY:-django-insecure-climbing-score-system-dev-key-change-in-production}
        python manage.py test scoring.tests --verbosity=0
    
    - name: Configure SSH
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ]; then
          echo "âš ï¸  è·³é SSH é…ç½®ï¼šæœªé…ç½® EC2 secrets"
          exit 0
        fi
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts || true
    
    - name: Deploy to EC2
      env:
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        if [ -z "$EC2_HOST" ] || [ -z "$EC2_USER" ] || [ -z "$EC2_SSH_KEY" ]; then
          echo "âš ï¸  è·³ééƒ¨ç½²ï¼šæœªé…ç½® EC2 secrets"
          echo "è«‹æª¢æŸ¥ GitHub Secrets é…ç½®ï¼š"
          echo "  - EC2_HOST: ${EC2_HOST:-æœªè¨­ç½®}"
          echo "  - EC2_USER: ${EC2_USER:-æœªè¨­ç½®}"
          echo "  - EC2_SSH_KEY: ${EC2_SSH_KEY:+å·²è¨­ç½®}${EC2_SSH_KEY:-æœªè¨­ç½®}"
          exit 0
        fi
        echo "é–‹å§‹éƒ¨ç½²åˆ° EC2..."
        echo "ç›®æ¨™: ${EC2_USER}@${EC2_HOST}"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
          set -e
          set -o pipefail
          
          # é€²å…¥é …ç›®ç›®éŒ„
          cd /var/www/Climbing_score_counter || {
            echo "âŒ éŒ¯èª¤: ç„¡æ³•é€²å…¥é …ç›®ç›®éŒ„ /var/www/Climbing_score_counter"
            exit 1
          }
          
          echo "=== é–‹å§‹éƒ¨ç½² ==="
          echo "æ™‚é–“: $(date)"
          echo "ç•¶å‰ç›®éŒ„: $(pwd)"
          
          # æ‹‰å–æœ€æ–°ä»£ç¢¼
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç¢¼..."
          if [ -d ".git" ]; then
            # ç¢ºä¿ Git å®‰å…¨ç›®éŒ„é…ç½®
            git config --global --add safe.directory /var/www/Climbing_score_counter || true
            
            # ä¿®å¾© .git ç›®éŒ„æ¬Šé™
            CURRENT_USER=$(whoami)
            if [ ! -w ".git" ] 2>/dev/null; then
              sudo chown -R $CURRENT_USER:$CURRENT_USER .git 2>/dev/null || true
            fi
            
            git fetch origin || {
              echo "âš ï¸  è­¦å‘Š: git fetch å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œéƒ¨ç½²"
            }
            
            CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
            echo "ç•¶å‰åˆ†æ”¯: $CURRENT_BRANCH"
            
            # è™•ç†æ•¸æ“šåº«æ–‡ä»¶è¡çª
            if [ -f "db.sqlite3" ] && ! git diff --quiet db.sqlite3 2>/dev/null; then
              echo "â„¹ï¸  æª¢æ¸¬åˆ°æ•¸æ“šåº«æ–‡ä»¶è®Šæ›´ï¼Œå‚™ä»½å¾Œé‡ç½®"
              mkdir -p backups
              cp db.sqlite3 backups/db_backup_$(date +%Y%m%d_%H%M%S).sqlite3 2>/dev/null || true
              git checkout -- db.sqlite3 2>/dev/null || true
            fi
            
            git reset --hard origin/main || git reset --hard origin/master || {
              echo "âš ï¸  è­¦å‘Š: git reset å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œéƒ¨ç½²"
            }
            
            echo "å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            echo "æœ€æ–°æäº¤: $(git log -1 --oneline 2>/dev/null || echo 'unknown')"
          else
            echo "âš ï¸  è­¦å‘Š: æœªæª¢æ¸¬åˆ° Git å€‰åº«ï¼Œè·³éä»£ç¢¼æ›´æ–°"
          fi
          
          # åŸ·è¡Œéƒ¨ç½²è…³æœ¬
          echo "ğŸš€ åŸ·è¡Œéƒ¨ç½²è…³æœ¬..."
          DEPLOY_SCRIPT="Deployment/scripts/tools/deploy.sh"
          
          if [ ! -f "$DEPLOY_SCRIPT" ]; then
            echo "âŒ éŒ¯èª¤: æ‰¾ä¸åˆ°éƒ¨ç½²è…³æœ¬ $DEPLOY_SCRIPT"
            echo "ç•¶å‰ç›®éŒ„: $(pwd)"
            echo "ç›®éŒ„å…§å®¹:"
            ls -la | head -20
            echo ""
            echo "Deployment ç›®éŒ„å…§å®¹:"
            ls -la Deployment/ 2>/dev/null || echo "Deployment ç›®éŒ„ä¸å­˜åœ¨"
            echo ""
            echo "Deployment/scripts ç›®éŒ„å…§å®¹:"
            ls -la Deployment/scripts/ 2>/dev/null || echo "Deployment/scripts ç›®éŒ„ä¸å­˜åœ¨"
            echo ""
            echo "Deployment/scripts/tools ç›®éŒ„å…§å®¹:"
            ls -la Deployment/scripts/tools/ 2>/dev/null || echo "Deployment/scripts/tools ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç¢ºä¿è…³æœ¬æœ‰åŸ·è¡Œæ¬Šé™
          chmod +x "$DEPLOY_SCRIPT"
          
          # åŸ·è¡Œéƒ¨ç½²è…³æœ¬ä¸¦æ•ç²éŒ¯èª¤
          if bash "$DEPLOY_SCRIPT"; then
            echo "âœ… éƒ¨ç½²è…³æœ¬åŸ·è¡ŒæˆåŠŸ"
          else
            EXIT_CODE=$?
            echo "âŒ éƒ¨ç½²è…³æœ¬åŸ·è¡Œå¤±æ•—ï¼Œé€€å‡ºç¢¼: $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo "=== éƒ¨ç½²å®Œæˆ ==="
          echo "æ™‚é–“: $(date)"
          echo ""
          echo "ğŸ“Š æœå‹™ç‹€æ…‹æª¢æŸ¥:"
          sudo systemctl status climbing_system --no-pager -l || {
            echo "âš ï¸  è­¦å‘Š: ç„¡æ³•ç²å–æœå‹™ç‹€æ…‹"
          }
          echo ""
          echo "ğŸ” é©—è­‰æœå‹™æ˜¯å¦é‹è¡Œ:"
          if sudo systemctl is-active --quiet climbing_system; then
            echo "âœ… climbing_system æœå‹™æ­£åœ¨é‹è¡Œ"
          else
            echo "âŒ climbing_system æœå‹™æœªé‹è¡Œ"
            echo "å˜—è©¦æŸ¥çœ‹æœå‹™æ—¥èªŒ:"
            sudo journalctl -u climbing_system --no-pager -n 20 || true
            exit 1
          fi
        ENDSSH
    
    - name: Skip deployment notice
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      if: env.EC2_HOST == '' || env.EC2_USER == '' || env.EC2_SSH_KEY == ''
      run: |
        echo "âš ï¸  è·³ééƒ¨ç½²ï¼šæœªé…ç½® EC2 secrets"
        echo "è«‹åœ¨ GitHub å€‰åº«è¨­ç½®ä¸­é…ç½®ä»¥ä¸‹ secretsï¼š"
        echo "  - EC2_HOST: EC2 å¯¦ä¾‹ IP æˆ–åŸŸå"
        echo "  - EC2_USER: SSH ç”¨æˆ¶åï¼ˆé€šå¸¸æ˜¯ ubuntuï¼‰"
        echo "  - EC2_SSH_KEY: SSH ç§é‘°å…§å®¹"
        echo ""
        echo "æ¸¬è©¦å·²é€šéï¼Œä½†éƒ¨ç½²æ­¥é©Ÿå·²è·³éã€‚"
    
    - name: Verify deployment
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
      if: env.EC2_HOST != ''
      continue-on-error: true
      run: |
        sleep 5
        response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 http://$EC2_HOST || echo "000")
        if [ "$response" = "000" ]; then
          echo "âš ï¸  è­¦å‘Š: ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ï¼ˆå¯èƒ½æœªé…ç½® EC2_HOST secret æˆ–æœå‹™å™¨æœªé‹è¡Œï¼‰"
          echo "é€™ä¸æœƒå°è‡´éƒ¨ç½²å¤±æ•—ï¼Œä½†è«‹æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹"
        elif [ "$response" != "200" ]; then
          echo "âš ï¸  è­¦å‘Š: éƒ¨ç½²å¾Œæœå‹™éŸ¿æ‡‰ç‹€æ…‹ç¢¼ç‚º $responseï¼ˆé æœŸ 200ï¼‰"
          echo "é€™ä¸æœƒå°è‡´éƒ¨ç½²å¤±æ•—ï¼Œä½†è«‹æª¢æŸ¥æœå‹™å™¨æ—¥èªŒ"
        else
          echo "âœ… éƒ¨ç½²é©—è­‰æˆåŠŸï¼Œæœå‹™éŸ¿æ‡‰æ­£å¸¸ï¼ˆHTTP $responseï¼‰"
        fi

