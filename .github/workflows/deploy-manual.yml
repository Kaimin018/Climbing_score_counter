name: Manual Deploy to AWS EC2

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '要部署的分支'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - master
          - develop
      skip_tests:
        description: '跳過測試'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Manual Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install system dependencies
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        sudo apt-get update
        sudo apt-get install -y libjpeg-dev zlib1g-dev
    
    - name: Install Python dependencies
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run migrations
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        python manage.py migrate --noinput
    
    - name: Run tests
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        python manage.py test scoring.tests --verbosity=0
    
    - name: Configure SSH
      if: ${{ secrets.EC2_HOST != '' && secrets.EC2_USER != '' && secrets.EC2_SSH_KEY != '' }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || true
    
    - name: Deploy to EC2
      if: ${{ secrets.EC2_HOST != '' && secrets.EC2_USER != '' && secrets.EC2_SSH_KEY != '' }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          set -e
          cd /var/www/Climbing_score_counter || {
            echo "錯誤: 無法進入項目目錄"
            exit 1
          }
          
          echo "=== 開始手動部署 ==="
          echo "分支: ${{ github.event.inputs.branch }}"
          echo "時間: \$(date)"
          
          # 拉取指定分支的最新代碼
          if [ -d ".git" ]; then
            git fetch origin
            git checkout ${{ github.event.inputs.branch }} || git checkout -b ${{ github.event.inputs.branch }}
            git reset --hard origin/${{ github.event.inputs.branch }}
          else
            echo "警告: 未檢測到 Git 倉庫，跳過代碼更新"
          fi
          
          # 執行部署腳本
          if [ -f "deploy.sh" ]; then
            bash deploy.sh
          else
            echo "錯誤: 找不到 deploy.sh 腳本"
            exit 1
          fi
          
          echo "=== 部署完成 ==="
        EOF
    
    - name: Skip deployment notice
      if: ${{ secrets.EC2_HOST == '' || secrets.EC2_USER == '' || secrets.EC2_SSH_KEY == '' }}
      run: |
        echo "⚠️  跳過部署：未配置 EC2 secrets"
        echo "請在 GitHub 倉庫設置中配置以下 secrets："
        echo "  - EC2_HOST"
        echo "  - EC2_USER"
        echo "  - EC2_SSH_KEY"

