name: Manual Deploy to AWS EC2

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '要部署的分支'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - master
          - develop
      skip_tests:
        description: '跳過測試'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Manual Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.branch }}
        fetch-depth: 0
    
    - name: Run tests
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python manage.py migrate
        python manage.py test scoring.tests --verbosity=0
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to EC2
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          set -e
          cd /var/www/Climbing_score_counter
          
          echo "=== 開始手動部署 ==="
          echo "分支: ${{ github.event.inputs.branch }}"
          echo "時間: \$(date)"
          
          # 拉取指定分支的最新代碼
          git fetch origin
          git checkout ${{ github.event.inputs.branch }}
          git reset --hard origin/${{ github.event.inputs.branch }}
          
          # 執行部署腳本
          bash deploy.sh
          
          echo "=== 部署完成 ==="
        EOF

