# iPhone 拍照更新路線流程分析

## 完整流程圖

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 用戶操作層                                                │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 用戶在 iPhone 上打開編輯路線彈窗        │
    │ - 點擊路線卡片                          │
    │ - 彈出編輯路線模態框                    │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 用戶點擊「選擇照片」按鈕                │
    │ - 觸發 input[type="file"] 的點擊事件  │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ iPhone 顯示選項對話框                  │
    │ - 拍照                                 │
    │ - 從圖庫選擇                           │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 用戶選擇「拍照」                        │
    │ - iPhone 相機打開                      │
    │ - 用戶拍照                             │
    │ - 照片被選中                           │
    └───────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 前端 JavaScript 處理層                                   │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ handlePhotoChange() 函數觸發            │
    │ - 讀取文件對象 (File object)            │
    │ - 文件信息：                            │
    │   * name: "IMG_XXXX.HEIC" 或無擴展名    │
    │   * type: "image/heic" 或 "image/jpeg" │
    │   * size: 文件大小（字節）              │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 同步文件到兩個 input 元素               │
    │ - editRoutePhoto (拍照輸入框)          │
    │ - editRoutePhotoFromGallery (圖庫輸入框)│
    │ - 使用 DataTransfer API 同步           │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ showPhotoPreview() 函數                │
    │ - 使用 FileReader 讀取文件             │
    │ - 轉換為 Data URL                      │
    │ - 顯示預覽圖片                         │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 用戶點擊「更新路線」按鈕                │
    │ - 觸發表單提交事件                     │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 構建 FormData                          │
    │ - name: 路線名稱                       │
    │ - grade: 難度等級                      │
    │ - photo: 照片文件 (File object)        │
    │ - member_completions: JSON 字符串      │
    │ - csrfmiddlewaretoken: CSRF token      │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 發送 PATCH 請求                        │
    │ - URL: /api/routes/{routeId}/         │
    │ - Method: PATCH                       │
    │ - Headers:                             │
    │   * X-CSRFToken: CSRF token            │
    │ - Body: FormData (multipart/form-data) │
    └───────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Django 後端處理層                                        │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ RouteViewSet.update() 方法              │
    │ - 獲取路線對象                          │
    │ - 調用 RouteUpdateSerializer            │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ RouteUpdateSerializer.is_valid()       │
    │ - 驗證所有字段                         │
    │ - 調用 validate_photo()                │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ validate_photo() 方法                  │
    │ ┌───────────────────────────────────┐ │
    │ │ 1. 檢查文件大小（限制 10MB）       │ │
    │ └───────────────────────────────────┘ │
    │ ┌───────────────────────────────────┐ │
    │ │ 2. 獲取文件名和 content_type       │ │
    │ │    - file_name: "IMG_XXXX.HEIC"   │ │
    │ │    - content_type: "image/heic"    │ │
    │ └───────────────────────────────────┘ │
    │ ┌───────────────────────────────────┐ │
    │ │ 3. 判斷是否為 HEIC 格式             │ │
    │ │    - 檢查 content_type              │ │
    │ │    - 檢查文件擴展名                 │ │
    │ └───────────────────────────────────┘ │
    │ ┌───────────────────────────────────┐ │
    │ │ 4. HEIC 轉換流程（如果是 HEIC）    │ │
    │ │    a. 嘗試使用 pyheif 轉換          │ │
    │ │       - pyheif.read_heif()          │ │
    │ │       - Image.frombytes()           │ │
    │ │       - 轉換為 RGB                   │ │
    │ │       - 保存為 JPEG                  │ │
    │ │       - 創建 InMemoryUploadedFile    │ │
    │ │    b. 如果 pyheif 未安裝，嘗試       │ │
    │ │       pillow-heif                   │ │
    │ │    c. 如果都失敗，使用後備方案       │ │
    │ │       （重命名文件）                 │ │
    │ └───────────────────────────────────┘ │
    │ ┌───────────────────────────────────┐ │
    │ │ 5. 非 HEIC 格式處理                │ │
    │ │    - 使用 Pillow 驗證               │ │
    │ │    - 如果沒有擴展名，根據           │ │
    │ │      content_type 添加              │ │
    │ └───────────────────────────────────┘ │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ RouteUpdateSerializer.save()           │
    │ - 更新路線對象                          │
    │ - 保存照片到 media/route_photos/       │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ Route.photo.save() (Django ImageField) │
    │ ┌───────────────────────────────────┐ │
    │ │ ❌ 錯誤發生點                        │ │
    │ │ ImageField 在保存前會進行額外驗證   │ │
    │ │ - 使用 Pillow 驗證文件內容           │ │
    │ │ - 檢查文件名格式                     │ │
    │ │ - 如果不符合預期，拋出錯誤：          │ │
    │ │   "The string did not match the     │ │
    │ │    expected pattern"                │ │
    │ └───────────────────────────────────┘ │
    └───────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 錯誤處理層                                                │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 錯誤返回前端                             │
    │ - HTTP 400 Bad Request                  │
    │ - 錯誤信息: "The string did not match   │
    │   the expected pattern"                 │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │ 前端顯示錯誤提示                         │
    │ - showToast('更新路線時發生錯誤: ...')  │
    └───────────────────────────────────────┘
```

## 關鍵問題點分析

### 問題點 1: 文件名格式

**位置**: `scoring/models.py` - `route_photo_upload_path()`

**問題**: 
- iPhone 拍照可能產生沒有擴展名的文件
- 文件名可能包含特殊字符
- 即使序列化器處理了，模型保存時仍會驗證原始文件名

**影響**: 
- ImageField 驗證失敗
- 拋出 "The string did not match the expected pattern" 錯誤

### 問題點 2: HEIC 轉換不完整

**位置**: `scoring/serializers.py` - `validate_photo()`

**問題**: 
- pyheif 轉換可能失敗但錯誤被吞掉
- 轉換後的 JPEG 文件可能有問題
- 原始 HEIC 文件可能被傳遞到模型層

**影響**: 
- ImageField 無法識別 HEIC 格式
- 驗證失敗

### 問題點 3: 文件對象屬性不完整

**位置**: `scoring/serializers.py` - `validate_photo()`

**問題**: 
- `InMemoryUploadedFile` 的某些屬性可能缺失
- 文件名可能沒有正確的擴展名
- content_type 可能不正確

**影響**: 
- ImageField 驗證失敗
- 模型保存失敗

### 問題點 4: 驗證時機問題

**位置**: Django ImageField 內部驗證

**問題**: 
- 序列化器已經驗證，但模型保存時 ImageField 仍會驗證
- 兩次驗證的標準可能不一致

**影響**: 
- 即使序列化器驗證通過，模型保存仍可能失敗

## 數據流示例

### 正常流程（JPEG 格式）

```
前端 File 對象:
  name: "IMG_1234.jpg"
  type: "image/jpeg"
  size: 2048576
        ↓
FormData:
  photo: File 對象
        ↓
序列化器 validate_photo():
  - 檢查大小: ✓
  - 檢查格式: JPEG ✓
  - 使用 Pillow 驗證: ✓
  - 返回: 原始 File 對象
        ↓
模型保存:
  - ImageField 驗證: ✓
  - 保存到: media/route_photos/route_1_20250101_120000.jpg
        ↓
成功 ✓
```

### 問題流程（HEIC 格式，轉換失敗）

```
前端 File 對象:
  name: "IMG_1234.HEIC"
  type: "image/heic"
  size: 2048576
        ↓
FormData:
  photo: File 對象
        ↓
序列化器 validate_photo():
  - 檢查大小: ✓
  - 檢查格式: HEIC ✓
  - 嘗試 pyheif 轉換: ❌ 失敗（但錯誤被吞掉）
  - 使用後備方案: 重命名為 .jpg
  - 返回: InMemoryUploadedFile (但內容仍是 HEIC)
        ↓
模型保存:
  - ImageField 驗證: ❌
  - Pillow 無法讀取 HEIC 內容
  - 拋出錯誤: "The string did not match the expected pattern"
        ↓
失敗 ❌
```

### 問題流程（無擴展名文件）

```
前端 File 對象:
  name: "photo" (無擴展名)
  type: "image/jpeg"
  size: 2048576
        ↓
FormData:
  photo: File 對象
        ↓
序列化器 validate_photo():
  - 檢查大小: ✓
  - 檢查格式: 非 HEIC ✓
  - 使用 Pillow 驗證: ✓
  - 添加擴展名: "photo.jpg" ✓
  - 返回: InMemoryUploadedFile
        ↓
模型保存:
  - route_photo_upload_path() 生成文件名
  - 如果文件名清理不完整: ❌
  - ImageField 驗證: ❌
  - 拋出錯誤: "The string did not match the expected pattern"
        ↓
失敗 ❌
```

## 解決方案優先級

### 優先級 1: 增強文件名清理（立即修復）

**修改**: `scoring/models.py` - `route_photo_upload_path()`

**原因**: 
- 最直接有效
- 不影響現有邏輯
- 可以處理所有文件名問題

### 優先級 2: 確保轉換後文件格式正確（中期優化）

**修改**: `scoring/serializers.py` - `validate_photo()`

**原因**: 
- 確保所有返回的文件對象都符合要求
- 避免轉換失敗的情況

### 優先級 3: 模型層自定義驗證（長期改進）

**修改**: `scoring/models.py` - `Route.save()`

**原因**: 
- 提供最後一道防線
- 確保所有保存的照片都符合要求

